<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plataforma OTT - Firebase</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="module">
    let currentUser = null;

    // ‚úÖ OJO: Ajusta esta URL si tu repo realmente usa /datos/contenido.json (y no /data/content.json)
    const CONTENT_URL = 'https://raw.githubusercontent.com/Stefany1-Guerrero/plataforma-ott/main/data/content.json';

    let contentCache = null;
    async function loadContent() {
      if (contentCache) return contentCache;
      const res = await fetch(CONTENT_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error('No se pudo cargar content.json');
      contentCache = await res.json();
      return contentCache;
    }

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    // ‚úÖ Importa helpers extra (tu grupo: stats + eventos + guardado)
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      collection,
      addDoc
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // ===== YouTube IFrame API + Quiz state =====
    let ytPlayer = null;
    let quizInterval = null;

    // video actual del JSON
    let currentVideoObj = null;
    let currentQuestions = [];
    let askedQuestions = new Set();

    // ======= ‚úÖ (GRUPO 4) Estad√≠stica =======
    let stats = {
      videoId: null,
      score10: 0,     // ‚úÖ nota sobre 10
      total: 0,       // ‚úÖ total de preguntas del video
      answered: 0,    // respondidas (1 intento)
      correct: 0,
      wrong: 0,
      clicks: 0
    };

    function calcScore10() {
      if (!stats.total) return 0;
      return Math.round(((stats.correct / stats.total) * 10) * 100) / 100; // 2 decimales
    }

    function updateScoreboard() {
      const el = document.getElementById('scoreboard');
      if (!el) return;
      el.textContent = `Nota: ${calcScore10()}/10 | Correctas: ${stats.correct}/${stats.total} | Incorrectas: ${stats.wrong}/${stats.total} | Respondidas: ${stats.answered}`;
    }

    function updateScoreDetails() {
      const el = document.getElementById('score-details');
      if (!el) return;
      el.textContent = `Errores: ${stats.wrong} | Clics: ${stats.clicks}`;
    }

    async function logEvent(type, extra = {}) {
      if (!currentUser) return;
      try {
        await addDoc(collection(db, 'users', currentUser.uid, 'events'), {
          type,
          videoId: stats.videoId,
          ...extra,
          createdAt: new Date().toISOString(),
        });
      } catch (e) {
        console.warn('No se pudo guardar evento', e);
      }
    }

    async function saveAnswer({ videoId, questionId, attemptsWrong, timeInVideo }) {
      if (!currentUser) return;
      try {
        await addDoc(collection(db, 'users', currentUser.uid, 'answers'), {
          videoId,
          questionId,
          attemptsWrong,
          timeInVideo,
          answeredAt: new Date().toISOString()
        });
      } catch (e) {
        console.warn('No se pudo guardar respuesta', e);
      }
    }

    async function saveVideoSummary() {
      if (!currentUser || !stats.videoId) return;
    
      const score10 = calcScore10();
    
      try {
        await setDoc(
          doc(db, 'users', currentUser.uid, 'videoAttempts', String(stats.videoId)),
          {
            videoId: stats.videoId,
            score10,
            total: stats.total,
            answered: stats.answered,
            correct: stats.correct,
            wrong: stats.wrong,
            clicks: stats.clicks,
            updatedAt: new Date().toISOString()
          },
          { merge: true }
        );
      } catch (e) {
        console.warn('No se pudo guardar resumen del video', e);
      }
    }

    function formatDateShort(iso) {
      try { return new Date(iso).toLocaleString(); } catch { return iso; }
    }
    
    function renderAttemptsTable(attempts = []) {
      const body = document.getElementById('attempts-body');
      const meta = document.getElementById('attempts-meta');
      if (!body) return;
    
      if (meta) meta.textContent = stats.videoId ? `Video ${stats.videoId}` : '';
    
      if (!attempts.length) {
        body.innerHTML = `<tr><td class="py-2 text-gray-400" colspan="6">A√∫n no hay intentos guardados para este video.</td></tr>`;
        return;
      }
    
      body.innerHTML = attempts.map((a, i) => `
        <tr class="border-t border-white/10">
          <td class="py-2">${i + 1}</td>
          <td class="py-2">${formatDateShort(a.at)}</td>
          <td class="py-2 font-semibold">${a.score10}</td>
          <td class="py-2">${a.correct}</td>
          <td class="py-2">${a.wrong}</td>
          <td class="py-2">${a.total}</td>
        </tr>
      `).join('');
    }
    
    async function loadLastAttempts(videoId) {
      if (!currentUser) { renderAttemptsTable([]); return; }
      try {
        const ref = doc(db, 'users', currentUser.uid, 'videoAttempts', String(videoId));
        const snap = await getDoc(ref);
        const data = snap.exists() ? snap.data() : null;
        renderAttemptsTable(data?.lastAttempts || []);
      } catch (e) {
        console.warn("No se pudo cargar intentos:", e);
        renderAttemptsTable([]);
      }
    }
    
    // ‚úÖ Guardar intento FINAL (max 3) - NO toca tu scoreboard, es aparte
    async function saveAttemptRollingFinal() {
      if (!currentUser || !stats.videoId) return;
    
      const attempt = {
        at: new Date().toISOString(),
        score10: calcScore10(),
        correct: stats.correct,
        wrong: stats.wrong,
        total: stats.total
      };
    
      try {
        const ref = doc(db, 'users', currentUser.uid, 'videoAttempts', String(stats.videoId));
        const snap = await getDoc(ref);
    
        let lastAttempts = [];
        if (snap.exists()) lastAttempts = snap.data().lastAttempts || [];
    
        // nuevo al inicio, mantener 3
        lastAttempts = [attempt, ...lastAttempts].slice(0, 3);
    
        await setDoc(ref, {
          videoId: stats.videoId,
          lastAttempts,
          updatedAt: new Date().toISOString()
        }, { merge: true });
    
        // refresca tabla en pantalla
        renderAttemptsTable(lastAttempts);
      } catch (e) {
        console.warn("No se pudo guardar intento final:", e);
      }
    }
    
    // ========= YouTube helpers =========
    function loadYouTubeAPI() {
      return new Promise((resolve) => {
        if (window.YT && window.YT.Player) return resolve();

        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        document.head.appendChild(tag);

        window.onYouTubeIframeAPIReady = () => resolve();
      });
    }

    function stopQuizWatcher() {
      if (quizInterval) clearInterval(quizInterval);
      quizInterval = null;
    }

    function startQuizWatcher() {
      stopQuizWatcher();

      quizInterval = setInterval(() => {
        if (!ytPlayer || !currentQuestions.length) return;

        const t = Math.floor(ytPlayer.getCurrentTime());

        // pregunta exacta en ese segundo
        const q = currentQuestions.find(q => q.time === t && !askedQuestions.has(q.id));
        if (q) {
          askedQuestions.add(q.id);
          showQuiz(q);
        }
      }, 500);
    }

    function showQuiz(q) {
      // pausa video
      try { ytPlayer.pauseVideo(); } catch {}

      const overlay = document.getElementById('quiz-overlay');
      const qEl = document.getElementById('quiz-question');
      const optsEl = document.getElementById('quiz-options');
      const fbEl = document.getElementById('quiz-feedback');
      const btnContinue = document.getElementById('quiz-continue');

      qEl.textContent = q.question;
      fbEl.textContent = '';
      fbEl.className = "text-sm mt-3 text-gray-300";
      btnContinue.style.display = 'none';
      optsEl.innerHTML = '';

      q.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = "w-full text-left bg-gray-700/60 hover:bg-gray-600/60 text-white rounded-lg px-4 py-3 transition-all";
        btn.textContent = opt;

        btn.addEventListener('click', async () => {
          // ‚úÖ Bloquear reintentos
          optsEl.querySelectorAll('button').forEach(b => b.disabled = true);
        
          // ‚úÖ Contadores locales (no dependen de Firestore)
          stats.clicks += 1;
        
          const isCorrect = idx === q.correctIndex;
          stats.answered += 1;
        
          if (isCorrect) {
            stats.correct += 1;
            fbEl.textContent = `‚úÖ Correcto. ${q.explanation || ''}`;
            fbEl.className = "text-sm mt-3 text-green-300";
          } else {
            stats.wrong += 1;
            fbEl.textContent = `‚ùå Incorrecto. ${q.explanation || ''}`;
            fbEl.className = "text-sm mt-3 text-red-300";
          }
        
          updateScoreboard();
          updateScoreDetails();
        
          // ‚úÖ IMPORTANT√çSIMO: programar el cierre ANTES de cualquier await
          setTimeout(() => {
            try { overlay.style.display = 'none'; } catch {}
            try { ytPlayer.playVideo(); } catch {}
          }, 700);
        
          // ‚úÖ Guardado/registro: que NO rompa el flujo si falla
          try {
            // si no hay usuario, no intentes guardar
            if (currentUser) {
              await logEvent('answer', {
                questionId: q.id,
                optionIndex: idx,
                isCorrect,
                timeInVideo: q.time
              });
        
              await addDoc(collection(db, 'users', currentUser.uid, 'answers'), {
                videoId: stats.videoId,
                questionId: q.id,
                selectedIndex: idx,
                isCorrect,
                timeInVideo: q.time,
                answeredAt: new Date().toISOString()
              });
        
              await saveVideoSummary();
            }
          } catch (e) {
            console.warn("Fallo guardando en Firestore, pero el video debe continuar:", e);
          }
        });

        optsEl.appendChild(btn);
      });

      overlay.style.display = 'flex';
    }

    // Configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCu-GYKblx8v94XMLeIEbpwpxJjxmihyaE",
      authDomain: "plataforma-ott.firebaseapp.com",
      projectId: "plataforma-ott",
      storageBucket: "plataforma-ott.firebasestorage.app",
      messagingSenderId: "623885901425",
      appId: "1:623885901425:web:d3fa5079d942eb064a05d0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    function showMessage(type, text) {
      const messageDiv = document.getElementById('message');
      if (!messageDiv) return;

      messageDiv.className = `flex items-center gap-2 p-4 rounded-lg mb-6 ${type === 'error' ? 'bg-red-500/20 border border-red-500/50' : 'bg-green-500/20 border border-green-500/50'}`;
      messageDiv.innerHTML = `
        <span class="text-2xl">${type === 'error' ? '‚ö†Ô∏è' : '‚úÖ'}</span>
        <span class="${type === 'error' ? 'text-red-300' : 'text-green-300'}">${text}</span>
      `;
      messageDiv.style.display = 'flex';

      if (type === 'success') {
        setTimeout(() => {
          messageDiv.style.display = 'none';
        }, 3000);
      }
    }

    async function handleRegister() {
      const name = document.getElementById('reg-name').value.trim();
      const email = document.getElementById('reg-email').value.trim();
      const password = document.getElementById('reg-password').value;
      const confirmPassword = document.getElementById('reg-confirm').value;

      if (!name || !email || !password || !confirmPassword) {
        showMessage('error', 'Todos los campos son obligatorios');
        return;
      }

      if (password !== confirmPassword) {
        showMessage('error', 'Las contrase√±as no coinciden');
        return;
      }

      if (password.length < 6) {
        showMessage('error', 'La contrase√±a debe tener al menos 6 caracteres');
        return;
      }

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        await setDoc(doc(db, 'users', user.uid), {
          name: name,
          email: email,
          createdAt: new Date().toISOString(),
          subscription: 'basic'
        });

        showMessage('success', '¬°Registro exitoso! Redirigiendo...');

        setTimeout(() => {
          document.getElementById('reg-name').value = '';
          document.getElementById('reg-email').value = '';
          document.getElementById('reg-password').value = '';
          document.getElementById('reg-confirm').value = '';
          switchToLogin();
        }, 2000);

      } catch (error) {
        console.error('Error:', error);
        let errorMessage = 'Error al registrar usuario';

        if (error.code === 'auth/email-already-in-use') {
          errorMessage = 'Este email ya est√° registrado';
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = 'Email inv√°lido';
        } else if (error.code === 'auth/weak-password') {
          errorMessage = 'La contrase√±a es muy d√©bil';
        }

        showMessage('error', errorMessage);
      }
    }

    async function handleLogin() {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;

      if (!email || !password) {
        showMessage('error', 'Email y contrase√±a son obligatorios');
        return;
      }

      try {
        await signInWithEmailAndPassword(auth, email, password);
        showMessage('success', 'Iniciando sesi√≥n...');

      } catch (error) {
        console.error('Error:', error);
        let errorMessage = 'Error al iniciar sesi√≥n';

        if (error.code === 'auth/user-not-found') {
          errorMessage = 'Usuario no encontrado';
        } else if (error.code === 'auth/wrong-password') {
          errorMessage = 'Contrase√±a incorrecta';
        } else if (error.code === 'auth/invalid-credential') {
          errorMessage = 'Email o contrase√±a incorrectos';
        } else if (error.code === 'auth/too-many-requests') {
          errorMessage = 'Demasiados intentos. Intenta m√°s tarde';
        }

        showMessage('error', errorMessage);
      }
    }

    async function handleLogout() {
      try {
        await signOut(auth);
        showMessage('success', 'Sesi√≥n cerrada exitosamente');
      } catch (error) {
        console.error('Error:', error);
        showMessage('error', 'Error al cerrar sesi√≥n');
      }
    }

    function renderLoginPage() {
      document.getElementById('root').innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 flex items-center justify-center p-4">
          <div class="bg-gray-800/50 backdrop-blur-lg rounded-2xl shadow-2xl p-8 w-full max-w-md border border-purple-500/20">
            <div class="text-center mb-8">
              <div class="text-6xl mb-4">üé¨</div>
              <h1 class="text-4xl font-bold text-white mb-2">Plataforma OTT</h1>
              <p class="text-gray-400">Con Firebase Database üî•</p>
            </div>

            <div id="message" style="display: none;"></div>

            <div class="flex gap-2 mb-6 bg-gray-700/30 p-1 rounded-lg">
              <button id="btn-login-tab" class="flex-1 py-2 px-4 rounded-md transition-all bg-gradient-to-r from-purple-500 to-pink-500 text-white">
                Iniciar Sesi√≥n
              </button>
              <button id="btn-register-tab" class="flex-1 py-2 px-4 rounded-md transition-all text-gray-400 hover:text-white">
                Registrarse
              </button>
            </div>

            <div id="login-form">
              <div class="space-y-4">
                <div>
                  <label class="block text-gray-300 mb-2 text-sm">üìß Email</label>
                  <input type="email" id="login-email" placeholder="tu@email.com"
                    class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                </div>
                <div>
                  <label class="block text-gray-300 mb-2 text-sm">üîí Contrase√±a</label>
                  <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                </div>
                <button id="btn-login" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600 transition-all transform hover:scale-105">
                  Iniciar Sesi√≥n
                </button>
              </div>
            </div>

            <div id="register-form" style="display: none;">
              <div class="space-y-4">
                <div>
                  <label class="block text-gray-300 mb-2 text-sm">üë§ Nombre Completo</label>
                  <input type="text" id="reg-name" placeholder="Juan P√©rez"
                    class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                </div>
                <div>
                  <label class="block text-gray-300 mb-2 text-sm">üìß Email</label>
                  <input type="email" id="reg-email" placeholder="tu@email.com"
                    class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                </div>
                <div>
                  <label class="block text-gray-300 mb-2 text-sm">üîí Contrase√±a (m√≠n. 6 caracteres)</label>
                  <input type="password" id="reg-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                </div>
                <div>
                  <label class="block text-gray-300 mb-2 text-sm">üîí Confirmar Contrase√±a</label>
                  <input type="password" id="reg-confirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                </div>
                <button id="btn-register" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600 transition-all transform hover:scale-105">
                  Crear Cuenta
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('btn-login-tab').addEventListener('click', switchToLogin);
      document.getElementById('btn-register-tab').addEventListener('click', switchToRegister);
      document.getElementById('btn-login').addEventListener('click', handleLogin);
      document.getElementById('btn-register').addEventListener('click', handleRegister);
    }

    function switchToLogin() {
      document.getElementById('login-form').style.display = 'block';
      document.getElementById('register-form').style.display = 'none';
      document.getElementById('btn-login-tab').className = 'flex-1 py-2 px-4 rounded-md transition-all bg-gradient-to-r from-purple-500 to-pink-500 text-white';
      document.getElementById('btn-register-tab').className = 'flex-1 py-2 px-4 rounded-md transition-all text-gray-400 hover:text-white';

      const messageDiv = document.getElementById('message');
      if (messageDiv) messageDiv.style.display = 'none';
    }

    function switchToRegister() {
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('register-form').style.display = 'block';
      document.getElementById('btn-login-tab').className = 'flex-1 py-2 px-4 rounded-md transition-all text-gray-400 hover:text-white';
      document.getElementById('btn-register-tab').className = 'flex-1 py-2 px-4 rounded-md transition-all bg-gradient-to-r from-purple-500 to-pink-500 text-white';

      const messageDiv = document.getElementById('message');
      if (messageDiv) messageDiv.style.display = 'none';
    }

    async function renderDashboard(user) {
      try {
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        const userData = userDoc.data();

        document.getElementById('root').innerHTML = `
          <div class="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 flex items-center justify-center p-4">
            <div class="bg-gray-800/50 backdrop-blur-lg rounded-2xl shadow-2xl p-8 w-full max-w-4xl border border-purple-500/20">
              <div class="flex items-center justify-between mb-8 flex-wrap gap-4">
                <h1 class="text-3xl font-bold text-white">üé¨ Mi Plataforma OTT</h1>
                <button id="btn-logout" class="px-6 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all">
                  Cerrar Sesi√≥n
                </button>
              </div>
        
              <div id="message" style="display: none;"></div>
        
              <div class="bg-gray-700/30 rounded-xl p-6 mb-6">
                <h2 class="text-2xl font-semibold text-white mb-4">¬°Bienvenido, ${userData.name}! üëã</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-300">
                  <p>üìß Email: ${userData.email}</p>
                  <p>üíé Plan: ${userData.subscription.toUpperCase()}</p>
                  <p>‚úÖ Estado: Activo</p>
                  <p>üìÖ Miembro desde: ${new Date(userData.createdAt).toLocaleDateString()}</p>
                  <p>üî• Base de datos: Firebase Firestore</p>
                  <p>üîí Seguridad: Activada</p>
                </div>
              </div>
        
              <div class="bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-xl p-6 border border-purple-500/30">
                <h3 class="text-xl font-semibold text-white mb-3">Contenido Disponible</h3>
                <p class="text-gray-300 mb-4">Explora todo el contenido de streaming disponible.</p>
        
                <div id="video-grid" class="grid grid-cols-2 md:grid-cols-3 gap-3">
                  ${[1, 2, 3, 4, 5, 6].map(num => `
                    <button class="video-btn bg-gray-700/50 rounded-lg p-4 text-center hover:bg-gray-600/50 transition-all cursor-pointer" data-video="${num}">
                      <p class="text-white font-medium text-sm md:text-base">üé¨ Video ${num}</p>
                    </button>
                  `).join('')}
                </div>
        
                <div id="video-player" style="display: none;" class="mt-6">
        
                  <!-- ================= HEADER VIDEO ================= -->
                  <div class="flex items-center justify-between mb-3 gap-3 flex-wrap">
                    <div>
                      <h4 class="text-lg font-semibold text-white" id="video-title"></h4>
        
                      <!-- ‚úÖ (GRUPO 4) Marcador como el ejemplo -->
                      <div class="text-sm text-gray-200 mt-1" id="scoreboard">Puntaje: 0 | Respondidas: 0</div>
                      <div class="text-xs text-gray-300 mt-1" id="score-details">Aciertos: 0 | Errores: 0 | %: 0% | Clics: 0</div>
                    </div>
        
                    <button id="close-video" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all">
                      Cerrar
                    </button>
                  </div>
        
                  <!-- ================= TABLA DE INTENTOS (SOLO UNA) ================= -->
                  <div class="w-full mt-4 mb-4 bg-gray-900/30 border border-purple-500/20 rounded-xl p-4">
                    <div class="flex items-center justify-between gap-2 mb-2">
                      <h5 class="text-white font-semibold">üìä √öltimos 3 intentos (video actual)</h5>
                      <span class="text-xs text-gray-400" id="attempts-meta"></span>
                    </div>
        
                    <div class="overflow-x-auto">
                      <table class="w-full text-sm text-gray-200">
                        <thead class="text-xs text-gray-300">
                          <tr>
                            <th class="text-left py-2">#</th>
                            <th class="text-left py-2">Fecha</th>
                            <th class="text-left py-2">Nota /10</th>
                            <th class="text-left py-2">Correctas</th>
                            <th class="text-left py-2">Incorrectas</th>
                            <th class="text-left py-2">Total</th>
                          </tr>
                        </thead>
                        <tbody id="attempts-body">
                          <tr>
                            <td class="py-2 text-gray-400" colspan="6">
                              Selecciona un video para ver intentos
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                  <!-- ================= FIN TABLA ================= -->
        
                  <!-- ================= VIDEO ================= -->
                  <div class="relative" style="padding-bottom: 56.25%; height: 0;">
                    <div class="relative" style="padding-bottom: 56.25%; height: 0;">
                      <!-- Aqu√≠ vive el reproductor controlable -->
                      <div id="youtube-player" style="position:absolute; top:0; left:0; width:100%; height:100%;"></div>
        
                      <!-- Overlay de preguntas -->
                      <div id="quiz-overlay"
                        style="display:none; position:absolute; top:0; left:0; width:100%; height:100%;"
                        class="bg-black/70 flex items-center justify-center p-4">
                        <div class="w-full max-w-xl bg-gray-800 rounded-xl border border-purple-500/30 p-5">
                          <h4 id="quiz-question" class="text-white text-lg font-semibold mb-4"></h4>
                          <div id="quiz-options" class="grid grid-cols-1 gap-2"></div>
                          <p id="quiz-feedback" class="text-sm mt-3 text-gray-300"></p>
        
                          <div class="flex justify-end gap-2 mt-4">
                            <button id="quiz-continue"
                              class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg"
                              style="display:none;">
                              Continuar
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- ================= FIN VIDEO ================= -->
        
                </div>
              </div>
            </div>
          </div>
        `;

        document.getElementById('btn-logout').addEventListener('click', handleLogout);

        const data = await loadContent();

        // mapa para usar igual que antes
        const videoLinks = {};
        const videoTitles = {};
        data.videos.forEach(v => {
          videoLinks[String(v.id)] = v.youtubeId;
          videoTitles[String(v.id)] = v.title || `Video ${v.id}`;
        });

        document.querySelectorAll('.video-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const videoNum = btn.dataset.video;
            const videoId = videoLinks[videoNum];
            const videoPlayer = document.getElementById('video-player');
            const videoTitle = document.getElementById('video-title');

            // 1) Cargar el objeto del video (para sus preguntas)
            currentVideoObj = data.videos.find(v => String(v.id) === String(videoNum)) || null;
            currentQuestions = (currentVideoObj?.questions || []).slice().sort((a, b) => a.time - b.time);
            askedQuestions = new Set();

            // ‚úÖ (GRUPO 4) reset de estad√≠stica por video
            stats = {
              videoId: Number(videoNum),
              score10: 0,
              total: currentQuestions.length, // ‚úÖ total preguntas del video
              answered: 0,
              correct: 0,
              wrong: 0,
              clicks: 0
            };
            
            updateScoreboard();
            updateScoreDetails();
            await logEvent('open_video', { videoId: stats.videoId, totalQuestions: stats.total });

            await loadLastAttempts(stats.videoId);

            // 2) Cargar YouTube API y crear/reusar player
            await loadYouTubeAPI();

            const playerDivId = 'youtube-player';

            if (ytPlayer) {
              ytPlayer.loadVideoById(videoId);
            } else {
              ytPlayer = new YT.Player(playerDivId, {
                videoId: videoId,
                playerVars: { autoplay: 1, rel: 0 },
                events: {
                  onReady: async () => {
                    await logEvent('player_ready', { videoId: stats.videoId });
                    startQuizWatcher();
                  },
                  onStateChange: async (e) => {
                    // Puedes contar tambi√©n play/pause como "clics" (eventos)
                    if (e.data === YT.PlayerState.PLAYING) {
                      await logEvent('play', { videoId: stats.videoId });
                      startQuizWatcher();
                    }
                    if (e.data === YT.PlayerState.PAUSED) {
                      await logEvent('pause', { videoId: stats.videoId });
                    }
                    if (e.data === YT.PlayerState.ENDED) {
                      stopQuizWatcher();
                      try { await saveVideoSummary(); } catch {}
                    
                      await saveAttemptRollingFinal(); // ‚úÖ guarda el resultado final en la tabla
                    
                      showMessage('success', `Video finalizado. Nota final: ${calcScore10()}/10 (Correctas: ${stats.correct}/${stats.total})`);
                    }
                  }
                }
              });
            }

            // 3) Mostrar reproductor
            videoTitle.textContent = videoTitles[videoNum] || `Video ${videoNum}`;
            videoPlayer.style.display = 'block';
            videoPlayer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            // 4) Iniciar vigilancia de preguntas
            startQuizWatcher();
          });
        });

        document.getElementById('close-video').addEventListener('click', async () => {
          const videoPlayer = document.getElementById('video-player');

          stopQuizWatcher();

          const overlay = document.getElementById('quiz-overlay');
          if (overlay) overlay.style.display = 'none';

          if (ytPlayer) {
            try { ytPlayer.stopVideo(); } catch {}
          }

          // ‚úÖ (GRUPO 4) guardar resumen final + evento
          await logEvent('close_video', { videoId: stats.videoId });
          await saveVideoSummary();

          videoPlayer.style.display = 'none';
        });

      } catch (error) {
        console.error('Error al cargar datos:', error);
        showMessage('error', 'Error al cargar informaci√≥n del usuario');
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        await renderDashboard(user);
      } else {
        currentUser = null;
        renderLoginPage();
      }
    });

    window.showMessage = showMessage;
  </script>
</body>
</html>
