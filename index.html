<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma OTT - Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCu-GYKblx8v94XMLeIEbpwpxJjxmihyaE",
            authDomain: "plataforma-ott.firebaseapp.com",
            projectId: "plataforma-ott",
            storageBucket: "plataforma-ott.firebasestorage.app",
            messagingSenderId: "623885901425",
            appId: "1:623885901425:web:d3fa5079d942eb064a05d0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;

        function showMessage(type, text) {
            const messageDiv = document.getElementById('message');
            if (!messageDiv) return;

            messageDiv.className = `flex items-center gap-2 p-4 rounded-lg mb-6 ${type === 'error' ? 'bg-red-500/20 border border-red-500/50' : 'bg-green-500/20 border border-green-500/50'}`;
            messageDiv.innerHTML = `
                <span class="text-2xl">${type === 'error' ? '‚ö†Ô∏è' : '‚úÖ'}</span>
                <span class="${type === 'error' ? 'text-red-300' : 'text-green-300'}">${text}</span>
            `;
            messageDiv.style.display = 'flex';

            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }
        }

        async function handleRegister() {
            const name = document.getElementById('reg-name').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value;
            const confirmPassword = document.getElementById('reg-confirm').value;

            if (!name || !email || !password || !confirmPassword) {
                showMessage('error', 'Todos los campos son obligatorios');
                return;
            }

            if (password !== confirmPassword) {
                showMessage('error', 'Las contrase√±as no coinciden');
                return;
            }

            if (password.length < 6) {
                showMessage('error', 'La contrase√±a debe tener al menos 6 caracteres');
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                await setDoc(doc(db, 'users', user.uid), {
                    name: name,
                    email: email,
                    createdAt: new Date().toISOString(),
                    subscription: 'basic'
                });

                showMessage('success', '¬°Registro exitoso! Redirigiendo...');

                setTimeout(() => {
                    document.getElementById('reg-name').value = '';
                    document.getElementById('reg-email').value = '';
                    document.getElementById('reg-password').value = '';
                    document.getElementById('reg-confirm').value = '';
                    switchToLogin();
                }, 2000);

            } catch (error) {
                console.error('Error:', error);
                let errorMessage = 'Error al registrar usuario';

                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Este email ya est√° registrado';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Email inv√°lido';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'La contrase√±a es muy d√©bil';
                }

                showMessage('error', errorMessage);
            }
        }

        async function handleLogin() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showMessage('error', 'Email y contrase√±a son obligatorios');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage('success', 'Iniciando sesi√≥n...');

            } catch (error) {
                console.error('Error:', error);
                let errorMessage = 'Error al iniciar sesi√≥n';

                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Usuario no encontrado';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Contrase√±a incorrecta';
                } else if (error.code === 'auth/invalid-credential') {
                    errorMessage = 'Email o contrase√±a incorrectos';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Demasiados intentos. Intenta m√°s tarde';
                }

                showMessage('error', errorMessage);
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                showMessage('success', 'Sesi√≥n cerrada exitosamente');
            } catch (error) {
                console.error('Error:', error);
                showMessage('error', 'Error al cerrar sesi√≥n');
            }
        }

        function renderLoginPage() {
            document.getElementById('root').innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 flex items-center justify-center p-4">
                    <div class="bg-gray-800/50 backdrop-blur-lg rounded-2xl shadow-2xl p-8 w-full max-w-md border border-purple-500/20">
                        <div class="text-center mb-8">
                            <div class="text-6xl mb-4">üé¨</div>
                            <h1 class="text-4xl font-bold text-white mb-2">Plataforma OTT</h1>
                            <p class="text-gray-400">Con Firebase Database üî•</p>
                        </div>

                        <div id="message" style="display: none;"></div>

                        <div class="flex gap-2 mb-6 bg-gray-700/30 p-1 rounded-lg">
                            <button id="btn-login-tab" class="flex-1 py-2 px-4 rounded-md transition-all bg-gradient-to-r from-purple-500 to-pink-500 text-white">
                                Iniciar Sesi√≥n
                            </button>
                            <button id="btn-register-tab" class="flex-1 py-2 px-4 rounded-md transition-all text-gray-400 hover:text-white">
                                Registrarse
                            </button>
                        </div>

                        <div id="login-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-gray-300 mb-2 text-sm">üìß Email</label>
                                    <input type="email" id="login-email" placeholder="tu@email.com"
                                        class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                                </div>
                                <div>
                                    <label class="block text-gray-300 mb-2 text-sm">üîí Contrase√±a</label>
                                    <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                        class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                                </div>
                                <button id="btn-login" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600 transition-all transform hover:scale-105">
                                    Iniciar Sesi√≥n
                                </button>
                            </div>
                        </div>

                        <div id="register-form" style="display: none;">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-gray-300 mb-2 text-sm">üë§ Nombre Completo</label>
                                    <input type="text" id="reg-name" placeholder="Juan P√©rez"
                                        class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                                </div>
                                <div>
                                    <label class="block text-gray-300 mb-2 text-sm">üìß Email</label>
                                    <input type="email" id="reg-email" placeholder="tu@email.com"
                                        class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                                </div>
                                <div>
                                    <label class="block text-gray-300 mb-2 text-sm">üîí Contrase√±a (m√≠n. 6 caracteres)</label>
                                    <input type="password" id="reg-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                        class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                                </div>
                                <div>
                                    <label class="block text-gray-300 mb-2 text-sm">üîí Confirmar Contrase√±a</label>
                                    <input type="password" id="reg-confirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                        class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                                </div>
                                <button id="btn-register" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600 transition-all transform hover:scale-105">
                                    Crear Cuenta
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('btn-login-tab').addEventListener('click', switchToLogin);
            document.getElementById('btn-register-tab').addEventListener('click', switchToRegister);
            document.getElementById('btn-login').addEventListener('click', handleLogin);
            document.getElementById('btn-register').addEventListener('click', handleRegister);
        }

        function switchToLogin() {
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('register-form').style.display = 'none';
            document.getElementById('btn-login-tab').className = 'flex-1 py-2 px-4 rounded-md transition-all bg-gradient-to-r from-purple-500 to-pink-500 text-white';
            document.getElementById('btn-register-tab').className = 'flex-1 py-2 px-4 rounded-md transition-all text-gray-400 hover:text-white';

            const messageDiv = document.getElementById('message');
            if (messageDiv) messageDiv.style.display = 'none';
        }

        function switchToRegister() {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('register-form').style.display = 'block';
            document.getElementById('btn-login-tab').className = 'flex-1 py-2 px-4 rounded-md transition-all text-gray-400 hover:text-white';
            document.getElementById('btn-register-tab').className = 'flex-1 py-2 px-4 rounded-md transition-all bg-gradient-to-r from-purple-500 to-pink-500 text-white';

            const messageDiv = document.getElementById('message');
            if (messageDiv) messageDiv.style.display = 'none';
        }

        function playVideo(url, title, description) {
            const player = document.getElementById('video-player');
            const frame = document.getElementById('video-frame');
            const videoTitle = document.getElementById('video-title');
            const videoDescription = document.getElementById('video-description');

            frame.src = url;
            videoTitle.textContent = title;
            videoDescription.textContent = description;

            player.classList.remove('hidden');
        }

        async function renderDashboard(user) {
            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                const userData = userDoc.data();

                // Obtener los videos desde Firestore
                const videosSnapshot = await getDocs(collection(db, 'videos'));
                const videos = videosSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                document.getElementById('root').innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 flex items-center justify-center p-4">
                        <div class="bg-gray-800/50 backdrop-blur-lg rounded-2xl shadow-2xl p-8 w-full max-w-4xl border border-purple-500/20">
                            <div class="flex items-center justify-between mb-8 flex-wrap gap-4">
                                <h1 class="text-3xl font-bold text-white">üé¨ Mi Plataforma OTT</h1>
                                <button id="btn-logout" class="px-6 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all">
                                    Cerrar Sesi√≥n
                                </button>
                            </div>

                            <div id="message" style="display: none;"></div>

                            <div class="bg-gray-700/30 rounded-xl p-6 mb-6">
                                <h2 class="text-2xl font-semibold text-white mb-4">¬°Bienvenido, ${userData.name}! üëã</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-300">
                                    <p>üìß Email: ${userData.email}</p>
                                    <p>üíé Plan: ${userData.subscription.toUpperCase()}</p>
                                    <p>‚úÖ Estado: Activo</p>
                                    <p>üìÖ Miembro desde: ${new Date(userData.createdAt).toLocaleDateString()}</p>
                                </div>
                            </div>

                            <!-- Men√∫ de Videos -->
                            <div class="bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-xl p-6 border border-purple-500/30">
                                <h3 class="text-xl font-semibold text-white mb-4">üé¨ Cat√°logo de Videos</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                    ${videos.map(video => `
                                        <div class="bg-gray-700/50 rounded-lg overflow-hidden hover:bg-gray-600/50 transition-all cursor-pointer transform hover:scale-102"
                                             onclick="playVideo('${video.url}', '${video.title}', '${video.description}')">
                                            <div class="h-40 bg-gray-600 flex items-center justify-center">
                                                ${video.thumbnail ? `<img src="${video.thumbnail}" alt="${video.title}" class="h-full w-full object-cover">` : '<span class="text-gray-400">Miniatura no disponible</span>'}
                                            </div>
                                            <div class="p-4">
                                                <h4 class="text-white font-medium">${video.title}</h4>
                                                <p class="text-gray-300 text-sm mt-1">${video.description}</p>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Reproductor de Video -->
                            <div id="video-player" class="mt-6 rounded-xl overflow-hidden bg-gray-700/50 hidden">
                                <div class="p-4">
                                    <h3 id="video-title" class="text-xl font-semibold text-white mb-2"></h3>
                                    <p id="video-description" class="text-gray-300 text-sm mb-4"></p>
                                    <div class="aspect-w-16 aspect-h-9">
                                        <iframe id="video-frame" class="w-full h-full" frameborder="0" allowfullscreen></iframe>
                                    </div>
                                    <button id="btn-back" class="mt-4 px-6 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition-all">
                                        Volver al Cat√°logo
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('btn-logout').addEventListener('click', handleLogout);
                document.getElementById('btn-back')?.addEventListener('click', () => {
                    document.getElementById('video-player').classList.add('hidden');
                });

            } catch (error) {
                console.error('Error al cargar datos:', error);
                showMessage('error', 'Error al cargar informaci√≥n del usuario o videos');
            }
        }

        // Funci√≥n para poblar Firestore con videos de ejemplo (ejecutar una vez)
        async function addSampleVideos() {
            const videos = [
                { title: "Pel√≠cula 1", description: "Una emocionante aventura", url: "https://www.youtube.com/embed/dQw4w9WgXcQ", category: "Pel√≠culas", thumbnail: "https://img.youtube.com/vi/dQw4w9WgXcQ/mqdefault.jpg" },
                { title: "Serie 1", description: "Cap√≠tulo piloto de la serie", url: "https://www.youtube.com/embed/dQw4w9WgXcQ", category: "Series", thumbnail: "https://img.youtube.com/vi/dQw4w9WgXcQ/mqdefault.jpg" },
                { title: "Documental 1", description: "Documental sobre la naturaleza", url: "https://www.youtube.com/embed/dQw4w9WgXcQ", category: "Documentales", thumbnail: "https://img.youtube.com/vi/dQw4w9WgXcQ/mqdefault.jpg" },
                { title: "Pel√≠cula 2", description: "Comedia familiar", url: "https://www.youtube.com/embed/dQw4w9WgXcQ", category: "Pel√≠culas", thumbnail: "https://img.youtube.com/vi/dQw4w9WgXcQ/mqdefault.jpg" },
                { title: "Serie 2", description: "Segunda temporada, episodio 1", url: "https://www.youtube.com/embed/dQw4w9WgXcQ", category: "Series", thumbnail: "https://img.youtube.com/vi/dQw4w9WgXcQ/mqdefault.jpg" },
                { title: "En Vivo", description: "Transmisi√≥n en vivo", url: "https://www.youtube.com/embed/dQw4w9WgXcQ", category: "En Vivo", thumbnail: "https://img.youtube.com/vi/dQw4w9WgXcQ/mqdefault.jpg" },
            ];

            for (const video of videos) {
                await setDoc(doc(db, 'videos', video.title.toLowerCase().replace(' ', '-')), video);
            }
            console.log('Videos de ejemplo a√±adidos');
        }

        // Descomenta la siguiente l√≠nea para poblar Firestore con videos de ejemplo (solo una vez)
        // addSampleVideos();

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await renderDashboard(user);
            } else {
                currentUser = null;
                renderLoginPage();
            }
        });

        window.showMessage = showMessage;
        window.playVideo = playVideo;
    </script>
</body>
</html>
