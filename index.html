<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Plataforma OTT - Firebase</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>
  <div id="root"></div>

  <script type="module">
    /***********************
     * 1) CONFIG + HELPERS
     ***********************/
    let currentUser = null;

    // ‚úÖ Tu JSON (videos + preguntas + time)
    const CONTENT_URL =
      "https://raw.githubusercontent.com/Stefany1-Guerrero/plataforma-ott/main/data/content.json";

    let contentCache = null;
    async function loadContent() {
      if (contentCache) return contentCache;
      const res = await fetch(CONTENT_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("No se pudo cargar content.json");
      contentCache = await res.json();
      return contentCache;
    }

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut,
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      updateDoc,
      collection,
      addDoc,
      getDocs,
      query,
      orderBy,
      limit,
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCu-GYKblx8v94XMLeIEbpwpxJjxmihyaE",
      authDomain: "plataforma-ott.firebaseapp.com",
      projectId: "plataforma-ott",
      storageBucket: "plataforma-ott.firebasestorage.app",
      messagingSenderId: "623885901425",
      appId: "1:623885901425:web:d3fa5079d942eb064a05d0",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    function isoNow() {
      return new Date().toISOString();
    }

    function showMessage(type, text) {
      const messageDiv = document.getElementById("message");
      if (!messageDiv) return;

      messageDiv.className = `flex items-center gap-2 p-4 rounded-lg mb-6 ${
        type === "error"
          ? "bg-red-500/20 border border-red-500/50"
          : "bg-green-500/20 border border-green-500/50"
      }`;
      messageDiv.innerHTML = `
        <span class="text-2xl">${type === "error" ? "‚ö†Ô∏è" : "‚úÖ"}</span>
        <span class="${type === "error" ? "text-red-300" : "text-green-300"}">${text}</span>
      `;
      messageDiv.style.display = "flex";

      if (type === "success") {
        setTimeout(() => (messageDiv.style.display = "none"), 2500);
      }
    }

    /**************************************
     * 2) YOUTUBE PLAYER + QUIZ (CORE)
     **************************************/
    let ytPlayer = null;
    let quizInterval = null;

    // Datos del video actual
    let currentVideoObj = null;
    let currentQuestions = [];
    let askedQuestions = new Set(); // evita disparar misma pregunta 2 veces durante reproducci√≥n

    // Intento actual (Firestore)
    let currentAttemptId = null;

    // Estado por pregunta (para el m√©todo nuevo)
    // questionState[qid] = { seen, firstSelectedIndex, firstCorrect, finalSelectedIndex, finalCorrect, wrongAttempts }
    let questionState = {};

    // Score (se calcula por "finalCorrect" al terminar/revisar)
    let stats = {
      videoId: null,
      score: 0,      // = #preguntas finalCorrect true
      answered: 0,   // preguntas con finalSelectedIndex != null
      correct: 0,    // = score
      wrong: 0,      // total intentos incorrectos (playback + review)
      clicks: 0,
    };

    // Modo revisi√≥n final
    let reviewMode = null;     // "wrong" | "all" | null
    let reviewQueue = [];      // array de preguntas a revisar
    let reviewIndex = 0;

    function calcAccuracy() {
      const total = currentQuestions.length || 0;
      return total ? Math.round((stats.score / total) * 100) : 0;
    }

    function recomputeStatsFromState() {
      const qs = Object.values(questionState);
      const totalWrong = qs.reduce((acc, q) => acc + (q.wrongAttempts || 0), 0);
      const answered = qs.filter((q) => q.finalSelectedIndex !== null && q.finalSelectedIndex !== undefined).length;
      const score = qs.filter((q) => q.finalCorrect === true).length;

      stats.score = score;
      stats.correct = score;
      stats.answered = answered;
      stats.wrong = totalWrong;

      updateScoreboard();
      updateScoreDetails();
    }

    function updateScoreboard() {
      const el = document.getElementById("scoreboard");
      if (!el) return;
      el.textContent = `Puntaje: ${stats.score} | Respondidas: ${stats.answered}`;
    }

    function updateScoreDetails() {
      const el = document.getElementById("score-details");
      if (!el) return;
      el.textContent = `Aciertos: ${stats.correct} | Errores: ${stats.wrong} | %: ${calcAccuracy()}% | Clics: ${stats.clicks}`;
    }

    // YouTube API loader
    function loadYouTubeAPI() {
      return new Promise((resolve) => {
        if (window.YT && window.YT.Player) return resolve();
        const tag = document.createElement("script");
        tag.src = "https://www.youtube.com/iframe_api";
        document.head.appendChild(tag);
        window.onYouTubeIframeAPIReady = () => resolve();
      });
    }

    function stopQuizWatcher() {
      if (quizInterval) clearInterval(quizInterval);
      quizInterval = null;
    }

    // ‚úÖ Watcher durante reproducci√≥n: dispara pregunta en el segundo exacto
    function startQuizWatcher() {
      stopQuizWatcher();
      quizInterval = setInterval(() => {
        if (!ytPlayer || !currentQuestions.length) return;
        const t = Math.floor(ytPlayer.getCurrentTime());
        const q = currentQuestions.find((q) => q.time === t && !askedQuestions.has(q.id));
        if (q) {
          askedQuestions.add(q.id);
          showQuizPlayback(q);
        }
      }, 500);
    }

    /**************************************
     * 3) FIRESTORE: ATTEMPTS + ANSWERS
     **************************************/
    async function createAttemptDoc(videoId, videoTitle) {
      if (!currentUser) return null;
      const ref = await addDoc(collection(db, "users", currentUser.uid, "attempts"), {
        videoId,
        videoTitle,
        startedAt: isoNow(),
        finishedAt: null,
        score: 0,
        answered: 0,
        correct: 0,
        wrong: 0,
        clicks: 0,
        accuracy: 0,
      });
      return ref.id;
    }

    async function saveAnswerDoc({ mode, questionId, selectedIndex, correct, timeInVideo }) {
      if (!currentUser || !currentAttemptId) return;
      try {
        await addDoc(collection(db, "users", currentUser.uid, "attempts", currentAttemptId, "answers"), {
          mode, // "playback" | "review"
          questionId,
          selectedIndex,
          correct,
          timeInVideo,
          createdAt: isoNow(),
        });
      } catch (e) {
        console.warn("No se pudo guardar answer", e);
      }
    }

    async function saveAttemptSummary() {
      if (!currentUser || !currentAttemptId) return;
      try {
        await updateDoc(doc(db, "users", currentUser.uid, "attempts", currentAttemptId), {
          finishedAt: null, // se pone al final real
          score: stats.score,
          answered: stats.answered,
          correct: stats.correct,
          wrong: stats.wrong,
          clicks: stats.clicks,
          accuracy: (currentQuestions.length ? stats.score / currentQuestions.length : 0),
          updatedAt: isoNow(),
        });
      } catch (e) {
        console.warn("No se pudo guardar resumen", e);
      }
    }

    async function closeAttemptSummary() {
      if (!currentUser || !currentAttemptId) return;
      try {
        await updateDoc(doc(db, "users", currentUser.uid, "attempts", currentAttemptId), {
          finishedAt: isoNow(),
          score: stats.score,
          answered: stats.answered,
          correct: stats.correct,
          wrong: stats.wrong,
          clicks: stats.clicks,
          accuracy: (currentQuestions.length ? stats.score / currentQuestions.length : 0),
          updatedAt: isoNow(),
        });
      } catch (e) {
        console.warn("No se pudo cerrar resumen", e);
      }
    }

    /*************************************************************
     * 4) M√âTODO NUEVO: PLAYBACK = 1 intento, si falla sigue video
     *************************************************************/
    function initQuestionState() {
      questionState = {};
      for (const q of currentQuestions) {
        questionState[q.id] = {
          seen: false,
          firstSelectedIndex: null,
          firstCorrect: null,
          finalSelectedIndex: null,
          finalCorrect: false,
          wrongAttempts: 0,
        };
      }
      recomputeStatsFromState();
    }

    function showQuizPlayback(q) {
      // pausa video
      try { ytPlayer.pauseVideo(); } catch {}

      const overlay = document.getElementById("quiz-overlay");
      const qEl = document.getElementById("quiz-question");
      const optsEl = document.getElementById("quiz-options");
      const fbEl = document.getElementById("quiz-feedback");
      const btnContinue = document.getElementById("quiz-continue");

      // UI
      qEl.textContent = q.question;
      fbEl.textContent = "Responde (solo 1 intento).";
      fbEl.className = "text-sm mt-3 text-gray-300";
      btnContinue.style.display = "none"; // ‚úÖ ya no se usa en playback
      btnContinue.onclick = null;

      optsEl.innerHTML = "";

      let answeredNow = false;

      q.options.forEach((opt, idx) => {
        const btn = document.createElement("button");
        btn.className =
          "w-full text-left bg-gray-700/60 hover:bg-gray-600/60 text-white rounded-lg px-4 py-3 transition-all";
        btn.textContent = opt;

        btn.addEventListener("click", async () => {
          if (answeredNow) return;
          answeredNow = true;

          // disable buttons
          [...optsEl.querySelectorAll("button")].forEach((b) => {
            b.disabled = true;
            b.classList.add("opacity-60", "cursor-not-allowed");
          });

          stats.clicks += 1;

          const st = questionState[q.id];
          st.seen = true;

          const isCorrect = idx === q.correctIndex;

          // Solo 1 intento: se guarda primera respuesta y se fija final por ahora
          st.firstSelectedIndex = idx;
          st.firstCorrect = isCorrect;

          // Si fue correcta, cuenta como finalCorrect
          if (isCorrect) {
            st.finalSelectedIndex = idx;
            st.finalCorrect = true;
            fbEl.textContent = `‚úÖ Correcto. El video contin√∫a‚Ä¶`;
            fbEl.className = "text-sm mt-3 text-green-300";
          } else {
            st.finalSelectedIndex = idx;   // queda registrada como final (pero podr√° cambiar en revisi√≥n)
            st.finalCorrect = false;
            st.wrongAttempts += 1;
            fbEl.textContent = `‚ùå Incorrecto. Registrado. El video contin√∫a‚Ä¶`;
            fbEl.className = "text-sm mt-3 text-red-300";
          }

          await saveAnswerDoc({
            mode: "playback",
            questionId: q.id,
            selectedIndex: idx,
            correct: isCorrect,
            timeInVideo: q.time
          });

          recomputeStatsFromState();
          await saveAttemptSummary();

          // cerrar overlay y seguir
          setTimeout(() => {
            overlay.style.display = "none";
            try { ytPlayer.playVideo(); } catch {}
          }, 900);
        });

        optsEl.appendChild(btn);
      });

      overlay.style.display = "flex";
    }

    /*************************************************************
     * 5) REVISI√ìN AL FINAL: puedes repetir preguntas y ganar puntaje
     *    - "Repasar incorrectas/no respondidas"
     *    - "Repasar todas"
     *************************************************************/
    function buildReviewQueue(mode) {
      const qs = currentQuestions.slice();
      if (mode === "all") return qs;

      // wrong/unanswered:
      return qs.filter((q) => {
        const st = questionState[q.id];
        const unanswered = st.finalSelectedIndex === null || st.finalSelectedIndex === undefined;
        const wrong = st.finalCorrect === false;
        return unanswered || wrong;
      });
    }

    function startReview(mode) {
      reviewMode = mode;
      reviewQueue = buildReviewQueue(mode);
      reviewIndex = 0;

      if (!reviewQueue.length) {
        showEndSummaryMessage("‚úÖ No hay preguntas pendientes para repasar.");
        return;
      }

      hideEndModal();
      showReviewQuestion(reviewQueue[reviewIndex]);
    }

    function showReviewQuestion(q) {
      const overlay = document.getElementById("quiz-overlay");
      const qEl = document.getElementById("quiz-question");
      const optsEl = document.getElementById("quiz-options");
      const fbEl = document.getElementById("quiz-feedback");
      const btnContinue = document.getElementById("quiz-continue");

      // En revisi√≥n NO dependemos del video
      try {
        ytPlayer.pauseVideo();
        ytPlayer.seekTo(q.time, true);
      } catch {}

      qEl.textContent = q.question;
      fbEl.textContent = "Modo repaso: puedes intentar hasta acertar para ganar el punto.";
      fbEl.className = "text-sm mt-3 text-gray-300";
      btnContinue.style.display = "none";
      btnContinue.onclick = null;

      optsEl.innerHTML = "";

      // en revisi√≥n puedes intentar varias veces hasta acertar
      let isSolved = false;

      q.options.forEach((opt, idx) => {
        const btn = document.createElement("button");
        btn.className =
          "w-full text-left bg-gray-700/60 hover:bg-gray-600/60 text-white rounded-lg px-4 py-3 transition-all";
        btn.textContent = opt;

        btn.addEventListener("click", async () => {
          if (isSolved) return;

          stats.clicks += 1;
          const st = questionState[q.id];
          const isCorrect = idx === q.correctIndex;

          await saveAnswerDoc({
            mode: "review",
            questionId: q.id,
            selectedIndex: idx,
            correct: isCorrect,
            timeInVideo: q.time
          });

          if (isCorrect) {
            // si antes estaba incorrecta, ahora gana punto
            st.finalSelectedIndex = idx;
            if (st.finalCorrect !== true) {
              st.finalCorrect = true;
            }
            fbEl.textContent = `‚úÖ Correcto.`;
            fbEl.className = "text-sm mt-3 text-green-300";
            isSolved = true;

            // deshabilita opciones y muestra bot√≥n siguiente
            [...optsEl.querySelectorAll("button")].forEach((b) => {
              b.disabled = true;
              b.classList.add("opacity-60", "cursor-not-allowed");
            });

            btnContinue.style.display = "inline-flex";
            btnContinue.textContent = (reviewIndex < reviewQueue.length - 1) ? "Siguiente" : "Finalizar repaso";
            btnContinue.onclick = async () => {
              btnContinue.style.display = "none";
              overlay.style.display = "none";

              recomputeStatsFromState();
              await saveAttemptSummary();

              reviewIndex += 1;
              if (reviewIndex >= reviewQueue.length) {
                showEndModal(); // volver al final
              } else {
                showReviewQuestion(reviewQueue[reviewIndex]);
              }
            };
          } else {
            st.wrongAttempts += 1;
            fbEl.textContent = `‚ùå Incorrecto. Intenta otra vez (repaso).`;
            fbEl.className = "text-sm mt-3 text-red-300";
            recomputeStatsFromState();
            await saveAttemptSummary();
          }
        });

        optsEl.appendChild(btn);
      });

      overlay.style.display = "flex";
    }

    /*************************************************************
     * 6) END MODAL: TABLA + BOTONES (lo que te faltaba)
     *************************************************************/
    function statusLabelFor(qid) {
      const st = questionState[qid];
      const unanswered = st.finalSelectedIndex === null || st.finalSelectedIndex === undefined;
      if (unanswered) return { text: "No respondida", cls: "text-yellow-300" };
      if (st.finalCorrect) return { text: "Correcta", cls: "text-green-300" };
      return { text: "Incorrecta", cls: "text-red-300" };
    }

    function buildEndTableHTML() {
      return `
        <div class="mt-4 overflow-auto max-h-72 border border-white/10 rounded-xl">
          <table class="w-full text-sm">
            <thead class="sticky top-0 bg-gray-900/90">
              <tr class="text-gray-200">
                <th class="text-left p-3">Pregunta</th>
                <th class="text-left p-3">Estado</th>
                <th class="text-left p-3">Errores</th>
                <th class="text-left p-3">Tiempo</th>
              </tr>
            </thead>
            <tbody>
              ${currentQuestions.map((q) => {
                const st = questionState[q.id];
                const s = statusLabelFor(q.id);
                return `
                  <tr class="border-t border-white/10">
                    <td class="p-3 text-gray-100">${q.question}</td>
                    <td class="p-3 ${s.cls} font-semibold">${s.text}</td>
                    <td class="p-3 text-gray-200">${st.wrongAttempts || 0}</td>
                    <td class="p-3 text-gray-200">${q.time}s</td>
                  </tr>
                `;
              }).join("")}
            </tbody>
          </table>
        </div>
      `;
    }

    function showEndSummaryMessage(msg) {
      const el = document.getElementById("end-summary");
      if (!el) return;
      el.innerHTML = `<div class="text-sm text-gray-200">${msg}</div>`;
    }

    function showEndModal() {
      const modal = document.getElementById("end-modal");
      const summary = document.getElementById("end-summary");
      if (!modal || !summary) return;

      recomputeStatsFromState();

      summary.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-gray-200">
          <div><b>Video:</b> ${currentVideoObj?.title || `Video ${stats.videoId}`}</div>
          <div><b>Intento:</b> ${currentAttemptId ? currentAttemptId.slice(0, 6) : "-"}</div>
          <div><b>Puntaje:</b> ${stats.score} / ${currentQuestions.length}</div>
          <div><b>Precisi√≥n:</b> ${calcAccuracy()}%</div>
          <div><b>Respondidas:</b> ${stats.answered}</div>
          <div><b>Errores (intentos):</b> ${stats.wrong}</div>
          <div><b>Clics:</b> ${stats.clicks}</div>
        </div>
        ${buildEndTableHTML()}
      `;

      modal.style.display = "flex";

      // wiring botones
      const btnWrong = document.getElementById("btn-review-wrong");
      const btnAll = document.getElementById("btn-review-all");
      const btnRetry = document.getElementById("btn-retry-video");
      const btnClose = document.getElementById("btn-end-close");

      if (btnWrong) btnWrong.onclick = () => startReview("wrong");
      if (btnAll) btnAll.onclick = () => startReview("all");
      if (btnRetry) btnRetry.onclick = () => retryVideoNewAttempt();
      if (btnClose) btnClose.onclick = () => hideEndModal();
    }

    function hideEndModal() {
      const modal = document.getElementById("end-modal");
      if (modal) modal.style.display = "none";
    }

    async function retryVideoNewAttempt() {
      hideEndModal();

      // Nuevo intento = nuevo doc
      if (!currentVideoObj || !stats.videoId) return;
      currentAttemptId = await createAttemptDoc(stats.videoId, currentVideoObj.title || `Video ${stats.videoId}`);

      // Reset estructuras
      askedQuestions = new Set();
      initQuestionState();
      stats.clicks = 0;
      recomputeStatsFromState();
      await saveAttemptSummary();

      // reinicia video
      try {
        ytPlayer.stopVideo();
        ytPlayer.loadVideoById(currentVideoObj.youtubeId);
      } catch {}

      // arranca watcher
      startQuizWatcher();
    }

    /*************************************************************
     * 7) AUTH: REGISTER / LOGIN / LOGOUT
     *************************************************************/
    async function handleRegister() {
      const name = document.getElementById("reg-name").value.trim();
      const email = document.getElementById("reg-email").value.trim();
      const password = document.getElementById("reg-password").value;
      const confirmPassword = document.getElementById("reg-confirm").value;

      if (!name || !email || !password || !confirmPassword) {
        showMessage("error", "Todos los campos son obligatorios");
        return;
      }
      if (password !== confirmPassword) {
        showMessage("error", "Las contrase√±as no coinciden");
        return;
      }
      if (password.length < 6) {
        showMessage("error", "La contrase√±a debe tener al menos 6 caracteres");
        return;
      }

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        await setDoc(doc(db, "users", user.uid), {
          name,
          email,
          createdAt: isoNow(),
          subscription: "basic",
        });

        showMessage("success", "¬°Registro exitoso! Redirigiendo...");
        setTimeout(() => {
          document.getElementById("reg-name").value = "";
          document.getElementById("reg-email").value = "";
          document.getElementById("reg-password").value = "";
          document.getElementById("reg-confirm").value = "";
          switchToLogin();
        }, 1500);
      } catch (error) {
        console.error("Error:", error);
        let errorMessage = "Error al registrar usuario";
        if (error.code === "auth/email-already-in-use") errorMessage = "Este email ya est√° registrado";
        if (error.code === "auth/invalid-email") errorMessage = "Email inv√°lido";
        if (error.code === "auth/weak-password") errorMessage = "La contrase√±a es muy d√©bil";
        showMessage("error", errorMessage);
      }
    }

    async function handleLogin() {
      const email = document.getElementById("login-email").value.trim();
      const password = document.getElementById("login-password").value;

      if (!email || !password) {
        showMessage("error", "Email y contrase√±a son obligatorios");
        return;
      }

      try {
        await signInWithEmailAndPassword(auth, email, password);
        showMessage("success", "Iniciando sesi√≥n...");
      } catch (error) {
        console.error("Error:", error);
        let errorMessage = "Error al iniciar sesi√≥n";
        if (error.code === "auth/user-not-found") errorMessage = "Usuario no encontrado";
        if (error.code === "auth/wrong-password") errorMessage = "Contrase√±a incorrecta";
        if (error.code === "auth/invalid-credential") errorMessage = "Email o contrase√±a incorrectos";
        if (error.code === "auth/too-many-requests") errorMessage = "Demasiados intentos. Intenta m√°s tarde";
        showMessage("error", errorMessage);
      }
    }

    async function handleLogout() {
      try {
        await signOut(auth);
        showMessage("success", "Sesi√≥n cerrada exitosamente");
      } catch (error) {
        console.error("Error:", error);
        showMessage("error", "Error al cerrar sesi√≥n");
      }
    }

    /*************************************************************
     * 8) UI: LOGIN PAGE
     *************************************************************/
    function renderLoginPage() {
      document.getElementById("root").innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 flex items-center justify-center p-4">
          <div class="bg-gray-800/50 backdrop-blur-lg rounded-2xl shadow-2xl p-8 w-full max-w-md border border-purple-500/20">
            <div class="text-center mb-8">
              <div class="text-6xl mb-4">üé¨</div>
              <h1 class="text-4xl font-bold text-white mb-2">Plataforma OTT</h1>
              <p class="text-gray-400">Con Firebase Firestore üî•</p>
            </div>

            <div id="message" style="display:none;"></div>

            <div class="flex gap-2 mb-6 bg-gray-700/30 p-1 rounded-lg">
              <button id="btn-login-tab" class="flex-1 py-2 px-4 rounded-md transition-all bg-gradient-to-r from-purple-500 to-pink-500 text-white">
                Iniciar Sesi√≥n
              </button>
              <button id="btn-register-tab" class="flex-1 py-2 px-4 rounded-md transition-all text-gray-400 hover:text-white">
                Registrarse
              </button>
            </div>

            <div id="login-form">
              <div class="space-y-4">
                <div>
                  <label class="block text-gray-300 mb-2 text-sm">üìß Email</label>
                  <input type="email" id="login-email" placeholder="tu@email.com"
                    class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                </div>
                <div>
                  <label class="block text-gray-300 mb-2 text-sm">üîí Contrase√±a</label>
                  <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                </div>
                <button id="btn-login"
                  class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600 transition-all transform hover:scale-105">
                  Iniciar Sesi√≥n
                </button>
              </div>
            </div>

            <div id="register-form" style="display:none;">
              <div class="space-y-4">
                <div>
                  <label class="block text-gray-300 mb-2 text-sm">üë§ Nombre Completo</label>
                  <input type="text" id="reg-name" placeholder="Juan P√©rez"
                    class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                </div>
                <div>
                  <label class="block text-gray-300 mb-2 text-sm">üìß Email</label>
                  <input type="email" id="reg-email" placeholder="tu@email.com"
                    class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                </div>
                <div>
                  <label class="block text-gray-300 mb-2 text-sm">üîí Contrase√±a (m√≠n. 6 caracteres)</label>
                  <input type="password" id="reg-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                </div>
                <div>
                  <label class="block text-gray-300 mb-2 text-sm">üîí Confirmar Contrase√±a</label>
                  <input type="password" id="reg-confirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                </div>
                <button id="btn-register"
                  class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600 transition-all transform hover:scale-105">
                  Crear Cuenta
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

      document.getElementById("btn-login-tab").addEventListener("click", switchToLogin);
      document.getElementById("btn-register-tab").addEventListener("click", switchToRegister);
      document.getElementById("btn-login").addEventListener("click", handleLogin);
      document.getElementById("btn-register").addEventListener("click", handleRegister);
    }

    function switchToLogin() {
      document.getElementById("login-form").style.display = "block";
      document.getElementById("register-form").style.display = "none";
      document.getElementById("btn-login-tab").className =
        "flex-1 py-2 px-4 rounded-md transition-all bg-gradient-to-r from-purple-500 to-pink-500 text-white";
      document.getElementById("btn-register-tab").className =
        "flex-1 py-2 px-4 rounded-md transition-all text-gray-400 hover:text-white";
      const messageDiv = document.getElementById("message");
      if (messageDiv) messageDiv.style.display = "none";
    }

    function switchToRegister() {
      document.getElementById("login-form").style.display = "none";
      document.getElementById("register-form").style.display = "block";
      document.getElementById("btn-login-tab").className =
        "flex-1 py-2 px-4 rounded-md transition-all text-gray-400 hover:text-white";
      document.getElementById("btn-register-tab").className =
        "flex-1 py-2 px-4 rounded-md transition-all bg-gradient-to-r from-purple-500 to-pink-500 text-white";
      const messageDiv = document.getElementById("message");
      if (messageDiv) messageDiv.style.display = "none";
    }

    /*************************************************************
     * 9) UI: DASHBOARD + PLAYER + MODALS
     *************************************************************/
    async function renderDashboard(user) {
      try {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        const userData = userDoc.data();

        document.getElementById("root").innerHTML = `
          <div class="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 flex items-center justify-center p-4">
            <div class="bg-gray-800/50 backdrop-blur-lg rounded-2xl shadow-2xl p-8 w-full max-w-5xl border border-purple-500/20">
              <div class="flex items-center justify-between mb-8 flex-wrap gap-4">
                <h1 class="text-3xl font-bold text-white">üé¨ Mi Plataforma OTT</h1>
                <button id="btn-logout" class="px-6 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all">
                  Cerrar Sesi√≥n
                </button>
              </div>

              <div id="message" style="display:none;"></div>

              <div class="bg-gray-700/30 rounded-xl p-6 mb-6">
                <h2 class="text-2xl font-semibold text-white mb-4">¬°Bienvenido, ${userData?.name || "Usuario"}! üëã</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-300">
                  <p>üìß Email: ${userData?.email || user.email}</p>
                  <p>üíé Plan: ${(userData?.subscription || "basic").toUpperCase()}</p>
                  <p>‚úÖ Estado: Activo</p>
                  <p>üìÖ Miembro desde: ${userData?.createdAt ? new Date(userData.createdAt).toLocaleDateString() : "-"}</p>
                  <p>üî• Base de datos: Firebase Firestore</p>
                  <p>üîí Seguridad: Activada</p>
                </div>
              </div>

              <div class="bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-xl p-6 border border-purple-500/30">
                <h3 class="text-xl font-semibold text-white mb-3">Contenido Disponible</h3>
                <p class="text-gray-300 mb-4">Explora todo el contenido de streaming disponible.</p>

                <div id="video-grid" class="grid grid-cols-2 md:grid-cols-3 gap-3">
                  ${[1,2,3,4,5,6].map(num => `
                    <button class="video-btn bg-gray-700/50 rounded-lg p-4 text-center hover:bg-gray-600/50 transition-all cursor-pointer" data-video="${num}">
                      <p class="text-white font-medium text-sm md:text-base">üé¨ Video ${num}</p>
                    </button>
                  `).join("")}
                </div>

                <div id="video-player" style="display:none;" class="mt-6">
                  <div class="flex items-center justify-between mb-3 gap-3 flex-wrap">
                    <div>
                      <h4 class="text-lg font-semibold text-white" id="video-title"></h4>
                      <div class="text-sm text-gray-200 mt-1" id="scoreboard">Puntaje: 0 | Respondidas: 0</div>
                      <div class="text-xs text-gray-300 mt-1" id="score-details">Aciertos: 0 | Errores: 0 | %: 0% | Clics: 0</div>
                      <div class="text-xs text-gray-400 mt-1" id="attempt-id"></div>
                    </div>

                    <button id="close-video" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all">
                      Cerrar
                    </button>
                  </div>

                  <div class="relative" style="padding-bottom:56.25%; height:0;">
                    <!-- Player -->
                    <div id="youtube-player" style="position:absolute; top:0; left:0; width:100%; height:100%;"></div>

                    <!-- Quiz overlay -->
                    <div id="quiz-overlay"
                      style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; z-index:50;"
                      class="bg-black/70 flex items-center justify-center p-4">
                      <div class="w-full max-w-xl bg-gray-800 rounded-xl border border-purple-500/30 p-5">
                        <h4 id="quiz-question" class="text-white text-lg font-semibold mb-4"></h4>
                        <div id="quiz-options" class="grid grid-cols-1 gap-2"></div>
                        <p id="quiz-feedback" class="text-sm mt-3 text-gray-300"></p>

                        <div class="flex justify-end gap-2 mt-4">
                          <button id="quiz-continue"
                            class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg"
                            style="display:none;">
                            Continuar
                          </button>
                        </div>
                      </div>
                    </div>

                    <!-- End modal -->
                    <div id="end-modal"
                      style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; z-index:60;"
                      class="bg-black/70 flex items-center justify-center p-4">
                      <div class="w-full max-w-3xl bg-gray-900 rounded-2xl border border-purple-500/30 p-6">
                        <h3 class="text-white text-xl font-bold mb-3">‚úÖ Video finalizado ‚Äî Resultados del intento</h3>

                        <div id="end-summary" class="mb-4"></div>

                        <div class="flex flex-wrap gap-2 justify-end">
                          <button id="btn-review-wrong" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg">
                            Repasar incorrectas/no respondidas
                          </button>
                          <button id="btn-review-all" class="px-4 py-2 bg-purple-600/70 hover:bg-purple-700 text-white rounded-lg">
                            Repasar todas
                          </button>
                          <button id="btn-retry-video" class="px-4 py-2 bg-pink-600 hover:bg-pink-700 text-white rounded-lg">
                            Repetir video (nuevo intento)
                          </button>
                          <button id="btn-end-close" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg">
                            Cerrar
                          </button>
                        </div>

                        <p class="text-xs text-gray-400 mt-4">
                          Cada vez que repites el video se crea un nuevo intento (documento) en Firestore:
                          <b>users/{uid}/attempts/{attemptId}</b>
                        </p>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        `;

        document.getElementById("btn-logout").addEventListener("click", handleLogout);

        const data = await loadContent();

        // Mapa videos desde JSON
        const videoLinks = {};
        const videoTitles = {};
        data.videos.forEach((v) => {
          videoLinks[String(v.id)] = v.youtubeId;
          videoTitles[String(v.id)] = v.title || `Video ${v.id}`;
        });

        // Eventos: click en video
        document.querySelectorAll(".video-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const videoNum = btn.dataset.video;
            const videoId = videoLinks[videoNum];
        
            if (!videoId) {
              showMessage("error", `No encontr√© el youtubeId para Video ${videoNum} en content.json`);
              return;
            }
        
            const videoPlayer = document.getElementById("video-player");
            const videoTitle = document.getElementById("video-title");
            const attemptIdEl = document.getElementById("attempt-id");
        
            // ‚úÖ 1) MOSTRAR primero el panel (evita bug de YT con display:none)
            videoTitle.textContent = videoTitles[videoNum] || `Video ${videoNum}`;
            videoPlayer.style.display = "block";
            videoPlayer.scrollIntoView({ behavior: "smooth", block: "nearest" });
        
            // Mensaje ‚Äúcargando‚Äù
            const ytDiv = document.getElementById("youtube-player");
            if (ytDiv) {
              ytDiv.innerHTML = `
                <div class="w-full h-full flex items-center justify-center text-white/80">
                  Cargando video...
                </div>
              `;
            }
        
            // ‚úÖ 2) Cargar data del video y preguntas
            currentVideoObj = data.videos.find((v) => String(v.id) === String(videoNum)) || null;
            currentQuestions = (currentVideoObj?.questions || []).slice().sort((a, b) => a.time - b.time);
            askedQuestions = new Set();
        
            stats = { videoId: Number(videoNum), score: 0, answered: 0, correct: 0, wrong: 0, clicks: 0 };
            initQuestionState();
        
            // ‚úÖ 3) Crear intento en Firestore
            currentAttemptId = await createAttemptDoc(stats.videoId, currentVideoObj?.title || `Video ${stats.videoId}`);
            if (attemptIdEl) attemptIdEl.textContent = currentAttemptId ? `Intento ID: ${currentAttemptId}` : "";
            await saveAttemptSummary();
        
            // ‚úÖ 4) Asegurar que el DOM ya ‚Äúpint√≥‚Äù antes de crear YT.Player
            await new Promise((r) => requestAnimationFrame(r));
        
            // ‚úÖ 5) Cargar API y montar player
            await loadYouTubeAPI();
        
            if (ytPlayer) {
              try {
                ytPlayer.loadVideoById(videoId);
              } catch (e) {
                console.warn("loadVideoById fall√≥, recreando player", e);
                ytPlayer = null;
              }
            }
        
            if (!ytPlayer) {
              ytPlayer = new YT.Player("youtube-player", {
                videoId,
                playerVars: { autoplay: 1, rel: 0 },
                events: {
                  onReady: () => {
                    startQuizWatcher();
                  },
                  onStateChange: async (e) => {
                    if (e.data === YT.PlayerState.PLAYING) startQuizWatcher();
                    if (e.data === YT.PlayerState.ENDED) {
                      stopQuizWatcher();
                      recomputeStatsFromState();
                      await closeAttemptSummary();
                      showEndModal();
                    }
                  },
                  onError: (e) => {
                    console.error("YouTube error:", e);
                    showMessage("error", "YouTube bloque√≥ o fall√≥ al cargar el video (revisa ID / permisos del video).");
                  }
                },
              });
            }
        
            // ‚úÖ 6) arrancar watcher (por si tarda en PLAYING)
            startQuizWatcher();
          });
        });

        // cerrar reproductor
        document.getElementById("close-video").addEventListener("click", async () => {
          stopQuizWatcher();

          const overlay = document.getElementById("quiz-overlay");
          if (overlay) overlay.style.display = "none";

          hideEndModal();

          if (ytPlayer) {
            try { ytPlayer.stopVideo(); } catch {}
          }

          await closeAttemptSummary();

          document.getElementById("video-player").style.display = "none";
        });
      } catch (error) {
        console.error("Error al cargar datos:", error);
        showMessage("error", "Error al cargar informaci√≥n del usuario");
      }
    }

    /*************************************************************
     * 10) AUTH STATE
     *************************************************************/
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        await renderDashboard(user);
      } else {
        currentUser = null;
        renderLoginPage();
      }
    });

    window.showMessage = showMessage;
  </script>
</body>
</html>
