<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Plataforma OTT - Firebase</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="module">
    let currentUser = null;

    // ‚úÖ IMPORTANTE: usa ruta relativa (GitHub Pages) ‚Üí evita fallos aleatorios de raw.githubusercontent
    const CONTENT_URL = './datos/content.json';

    let contentCache = null;
    async function loadContent() {
      if (contentCache) return contentCache;

      const res = await fetch(CONTENT_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error(`No se pudo cargar content.json (HTTP ${res.status})`);
      const data = await res.json();

      if (!data?.videos?.length) throw new Error('El JSON no tiene "videos".');
      contentCache = data;
      return contentCache;
    }

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // ===== YouTube IFrame API + Quiz state =====
    let ytPlayer = null;
    let quizInterval = null;

    // video actual del JSON
    let currentVideoObj = null;
    let currentQuestions = [];
    let askedQuestions = new Set();

    function loadYouTubeAPI() {
      return new Promise((resolve) => {
        if (window.YT && window.YT.Player) return resolve();

        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        document.head.appendChild(tag);

        window.onYouTubeIframeAPIReady = () => resolve();
      });
    }

    function stopQuizWatcher() {
      if (quizInterval) clearInterval(quizInterval);
      quizInterval = null;
    }

    function startQuizWatcher() {
      stopQuizWatcher();

      quizInterval = setInterval(() => {
        if (!ytPlayer || !currentQuestions.length) return;

        const t = Math.floor(ytPlayer.getCurrentTime());

        // pregunta exacta en ese segundo
        const q = currentQuestions.find(q => q.time === t && !askedQuestions.has(q.id));
        if (q) {
          askedQuestions.add(q.id);
          showQuiz(q);
        }
      }, 500);
    }

    function showQuiz(q) {
      // pausa video
      try { ytPlayer.pauseVideo(); } catch {}

      const overlay = document.getElementById('quiz-overlay');
      const qEl = document.getElementById('quiz-question');
      const optsEl = document.getElementById('quiz-options');
      const fbEl = document.getElementById('quiz-feedback');
      const btnContinue = document.getElementById('quiz-continue');

      if (!overlay || !qEl || !optsEl || !fbEl || !btnContinue) return;

      qEl.textContent = q.question;
      fbEl.textContent = '';
      fbEl.className = "text-sm mt-3 text-gray-300";
      btnContinue.style.display = 'none';
      optsEl.innerHTML = '';

      q.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = "w-full text-left bg-gray-700/60 hover:bg-gray-600/60 text-white rounded-lg px-4 py-3 transition-all";
        btn.textContent = opt;

        btn.addEventListener('click', () => {
          const correct = idx === q.correctIndex;

          if (correct) {
            fbEl.textContent = `‚úÖ Correcto. ${q.explanation || ''}`;
            fbEl.className = "text-sm mt-3 text-green-300";
            btnContinue.style.display = 'inline-flex';
          } else {
            fbEl.textContent = "‚ùå Incorrecto. Intenta otra vez.";
            fbEl.className = "text-sm mt-3 text-red-300";
          }
        });

        optsEl.appendChild(btn);
      });

      btnContinue.onclick = () => {
        overlay.style.display = 'none';
        try { ytPlayer.playVideo(); } catch {}
      };

      overlay.style.display = 'flex';
    }

    // Configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCu-GYKblx8v94XMLeIEbpwpxJjxmihyaE",
      authDomain: "plataforma-ott.firebaseapp.com",
      projectId: "plataforma-ott",
      storageBucket: "plataforma-ott.firebasestorage.app",
      messagingSenderId: "623885901425",
      appId: "1:623885901425:web:d3fa5079d942eb064a05d0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    function showMessage(type, text) {
      const messageDiv = document.getElementById('message');
      if (!messageDiv) return;

      messageDiv.className =
        `flex items-center gap-2 p-4 rounded-lg mb-6 ${type === 'error'
          ? 'bg-red-500/20 border border-red-500/50'
          : 'bg-green-500/20 border border-green-500/50'}`;

      messageDiv.innerHTML = `
        <span class="text-2xl">${type === 'error' ? '‚ö†Ô∏è' : '‚úÖ'}</span>
        <span class="${type === 'error' ? 'text-red-300' : 'text-green-300'}">${text}</span>
      `;
      messageDiv.style.display = 'flex';

      // ‚úÖ que el error no se quede pegado para siempre
      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, type === 'error' ? 6000 : 3000);
    }

    async function handleRegister() {
      const name = document.getElementById('reg-name').value.trim();
      const email = document.getElementById('reg-email').value.trim();
      const password = document.getElementById('reg-password').value;
      const confirmPassword = document.getElementById('reg-confirm').value;

      if (!name || !email || !password || !confirmPassword) {
        showMessage('error', 'Todos los campos son obligatorios');
        return;
      }

      if (password !== confirmPassword) {
        showMessage('error', 'Las contrase√±as no coinciden');
        return;
      }

      if (password.length < 6) {
        showMessage('error', 'La contrase√±a debe tener al menos 6 caracteres');
        return;
      }

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        await setDoc(doc(db, 'users', user.uid), {
          name: name,
          email: email,
          createdAt: new Date().toISOString(),
          subscription: 'basic'
        });

        showMessage('success', '¬°Registro exitoso! Redirigiendo...');

        setTimeout(() => {
          document.getElementById('reg-name').value = '';
          document.getElementById('reg-email').value = '';
          document.getElementById('reg-password').value = '';
          document.getElementById('reg-confirm').value = '';
          switchToLogin();
        }, 1500);

      } catch (error) {
        console.error('Error:', error);
        let errorMessage = 'Error al registrar usuario';

        if (error.code === 'auth/email-already-in-use') {
          errorMessage = 'Este email ya est√° registrado';
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = 'Email inv√°lido';
        } else if (error.code === 'auth/weak-password') {
          errorMessage = 'La contrase√±a es muy d√©bil';
        }

        showMessage('error', errorMessage);
      }
    }

    async function handleLogin() {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;

      if (!email || !password) {
        showMessage('error', 'Email y contrase√±a son obligatorios');
        return;
      }

      try {
        await signInWithEmailAndPassword(auth, email, password);
        showMessage('success', 'Iniciando sesi√≥n...');
      } catch (error) {
        console.error('Error:', error);
        let errorMessage = 'Error al iniciar sesi√≥n';

        if (error.code === 'auth/user-not-found') {
          errorMessage = 'Usuario no encontrado';
        } else if (error.code === 'auth/wrong-password') {
          errorMessage = 'Contrase√±a incorrecta';
        } else if (error.code === 'auth/invalid-credential') {
          errorMessage = 'Email o contrase√±a incorrectos';
        } else if (error.code === 'auth/too-many-requests') {
          errorMessage = 'Demasiados intentos. Intenta m√°s tarde';
        }

        showMessage('error', errorMessage);
      }
    }

    async function handleLogout() {
      try {
        // ‚úÖ limpia cache para recargar JSON en siguiente login
        contentCache = null;
        await signOut(auth);
        showMessage('success', 'Sesi√≥n cerrada exitosamente');
      } catch (error) {
        console.error('Error:', error);
        showMessage('error', 'Error al cerrar sesi√≥n');
      }
    }

    function renderLoginPage() {
      document.getElementById('root').innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 flex items-center justify-center p-4">
          <div class="bg-gray-800/50 backdrop-blur-lg rounded-2xl shadow-2xl p-8 w-full max-w-md border border-purple-500/20">
            <div class="text-center mb-8">
              <div class="text-6xl mb-4">üé¨</div>
              <h1 class="text-4xl font-bold text-white mb-2">Plataforma OTT</h1>
              <p class="text-gray-400">Con Firebase Database üî•</p>
            </div>

            <div id="message" style="display: none;"></div>

            <div class="flex gap-2 mb-6 bg-gray-700/30 p-1 rounded-lg">
              <button id="btn-login-tab" class="flex-1 py-2 px-4 rounded-md transition-all bg-gradient-to-r from-purple-500 to-pink-500 text-white">
                Iniciar Sesi√≥n
              </button>
              <button id="btn-register-tab" class="flex-1 py-2 px-4 rounded-md transition-all text-gray-400 hover:text-white">
                Registrarse
              </button>
            </div>

            <div id="login-form">
              <div class="space-y-4">
                <div>
                  <label class="block text-gray-300 mb-2 text-sm">üìß Email</label>
                  <input type="email" id="login-email" placeholder="tu@email.com"
                    class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                </div>
                <div>
                  <label class="block text-gray-300 mb-2 text-sm">üîí Contrase√±a</label>
                  <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                </div>
                <button id="btn-login" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600 transition-all transform hover:scale-105">
                  Iniciar Sesi√≥n
                </button>
              </div>
            </div>

            <div id="register-form" style="display: none;">
              <div class="space-y-4">
                <div>
                  <label class="block text-gray-300 mb-2 text-sm">üë§ Nombre Completo</label>
                  <input type="text" id="reg-name" placeholder="Juan P√©rez"
                    class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                </div>
                <div>
                  <label class="block text-gray-300 mb-2 text-sm">üìß Email</label>
                  <input type="email" id="reg-email" placeholder="tu@email.com"
                    class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                </div>
                <div>
                  <label class="block text-gray-300 mb-2 text-sm">üîí Contrase√±a (m√≠n. 6 caracteres)</label>
                  <input type="password" id="reg-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                </div>
                <div>
                  <label class="block text-gray-300 mb-2 text-sm">üîí Confirmar Contrase√±a</label>
                  <input type="password" id="reg-confirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                </div>
                <button id="btn-register" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600 transition-all transform hover:scale-105">
                  Crear Cuenta
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('btn-login-tab').addEventListener('click', switchToLogin);
      document.getElementById('btn-register-tab').addEventListener('click', switchToRegister);
      document.getElementById('btn-login').addEventListener('click', handleLogin);
      document.getElementById('btn-register').addEventListener('click', handleRegister);
    }

    function switchToLogin() {
      document.getElementById('login-form').style.display = 'block';
      document.getElementById('register-form').style.display = 'none';
      document.getElementById('btn-login-tab').className = 'flex-1 py-2 px-4 rounded-md transition-all bg-gradient-to-r from-purple-500 to-pink-500 text-white';
      document.getElementById('btn-register-tab').className = 'flex-1 py-2 px-4 rounded-md transition-all text-gray-400 hover:text-white';
      const messageDiv = document.getElementById('message');
      if (messageDiv) messageDiv.style.display = 'none';
    }

    function switchToRegister() {
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('register-form').style.display = 'block';
      document.getElementById('btn-login-tab').className = 'flex-1 py-2 px-4 rounded-md transition-all text-gray-400 hover:text-white';
      document.getElementById('btn-register-tab').className = 'flex-1 py-2 px-4 rounded-md transition-all bg-gradient-to-r from-purple-500 to-pink-500 text-white';
      const messageDiv = document.getElementById('message');
      if (messageDiv) messageDiv.style.display = 'none';
    }

    async function renderDashboard(user) {
      try {
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        const userData = userDoc.data();

        document.getElementById('root').innerHTML = `
          <div class="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 flex items-center justify-center p-4">
            <div class="bg-gray-800/50 backdrop-blur-lg rounded-2xl shadow-2xl p-8 w-full max-w-4xl border border-purple-500/20">
              <div class="flex items-center justify-between mb-8 flex-wrap gap-4">
                <h1 class="text-3xl font-bold text-white">üé¨ Mi Plataforma OTT</h1>
                <button id="btn-logout" class="px-6 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all">
                  Cerrar Sesi√≥n
                </button>
              </div>

              <div id="message" style="display: none;"></div>

              <div class="bg-gray-700/30 rounded-xl p-6 mb-6">
                <h2 class="text-2xl font-semibold text-white mb-4">¬°Bienvenido, ${userData?.name || 'Usuario'}! üëã</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-300">
                  <p>üìß Email: ${userData?.email || ''}</p>
                  <p>üíé Plan: ${(userData?.subscription || 'basic').toUpperCase()}</p>
                  <p>‚úÖ Estado: Activo</p>
                  <p>üìÖ Miembro desde: ${userData?.createdAt ? new Date(userData.createdAt).toLocaleDateString() : ''}</p>
                  <p>üî• Base de datos: Firebase Firestore</p>
                  <p>üîí Seguridad: Activada</p>
                </div>
              </div>

              <div class="bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-xl p-6 border border-purple-500/30">
                <h3 class="text-xl font-semibold text-white mb-3">Contenido Disponible</h3>
                <p class="text-gray-300 mb-4">Explora todo el contenido de streaming disponible.</p>

                <div id="video-grid" class="grid grid-cols-2 md:grid-cols-3 gap-3">
                  ${[1, 2, 3, 4, 5, 6].map(num => `
                    <button class="video-btn bg-gray-700/50 rounded-lg p-4 text-center hover:bg-gray-600/50 transition-all cursor-pointer" data-video="${num}">
                      <p class="text-white font-medium text-sm md:text-base">üé¨ Video ${num}</p>
                    </button>
                  `).join('')}
                </div>

                <div id="video-player" style="display:none;" class="mt-6">
                  <div class="flex items-center justify-between mb-3">
                    <h4 class="text-lg font-semibold text-white" id="video-title"></h4>
                    <button id="close-video" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all">
                      Cerrar
                    </button>
                  </div>

                  <div class="relative" style="padding-bottom:56.25%; height:0;">
                    <div id="youtube-player" style="position:absolute; top:0; left:0; width:100%; height:100%;"></div>

                    <div id="quiz-overlay"
                      style="display:none; position:absolute; top:0; left:0; width:100%; height:100%;"
                      class="bg-black/70 flex items-center justify-center p-4">
                      <div class="w-full max-w-xl bg-gray-800 rounded-xl border border-purple-500/30 p-5">
                        <h4 id="quiz-question" class="text-white text-lg font-semibold mb-4"></h4>
                        <div id="quiz-options" class="grid grid-cols-1 gap-2"></div>
                        <p id="quiz-feedback" class="text-sm mt-3 text-gray-300"></p>
                        <div class="flex justify-end gap-2 mt-4">
                          <button id="quiz-continue"
                            class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg"
                            style="display:none;">
                            Continuar
                          </button>
                        </div>
                      </div>
                    </div>

                  </div>
                </div>

              </div>
            </div>
          </div>
        `;

        document.getElementById('btn-logout').addEventListener('click', handleLogout);

        // ‚úÖ Carga de JSON
        const data = await loadContent();

        // mapas
        const videoLinks = {};
        const videoTitles = {};
        data.videos.forEach(v => {
          videoLinks[String(v.id)] = v.youtubeId;
          videoTitles[String(v.id)] = v.title || `Video ${v.id}`;
        });

        // ‚úÖ CLICK ROBUSTO (delegaci√≥n): siempre funciona aunque re-renderices
        document.getElementById('video-grid').addEventListener('click', async (e) => {
          const btn = e.target.closest('.video-btn');
          if (!btn) return;

          const videoNum = btn.dataset.video;
          const videoId = videoLinks[String(videoNum)];

          const videoPlayer = document.getElementById('video-player');
          const videoTitle = document.getElementById('video-title');

          if (!videoId) {
            showMessage('error', `No se encontr√≥ youtubeId para Video ${videoNum}. Revisa datos/content.json`);
            return;
          }

          videoTitle.textContent = videoTitles[String(videoNum)] || `Video ${videoNum}`;
          videoPlayer.style.display = 'block';
          videoPlayer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

          // preguntas del video
          currentVideoObj = data.videos.find(v => String(v.id) === String(videoNum)) || null;
          currentQuestions = (currentVideoObj?.questions || []).slice().sort((a, b) => a.time - b.time);
          askedQuestions = new Set();

          // YouTube API
          await loadYouTubeAPI();

          if (ytPlayer) {
            ytPlayer.loadVideoById(videoId);
          } else {
            ytPlayer = new YT.Player('youtube-player', {
              videoId: videoId,
              playerVars: { autoplay: 1, rel: 0 },
              events: {
                onReady: () => startQuizWatcher(),
                onStateChange: (ev) => {
                  if (ev.data === YT.PlayerState.PLAYING) startQuizWatcher();
                  if (ev.data === YT.PlayerState.ENDED) stopQuizWatcher();
                }
              }
            });
          }

          startQuizWatcher();
        });

        document.getElementById('close-video').addEventListener('click', () => {
          stopQuizWatcher();

          const overlay = document.getElementById('quiz-overlay');
          if (overlay) overlay.style.display = 'none';

          if (ytPlayer) {
            try { ytPlayer.stopVideo(); } catch {}
          }

          const videoPlayer = document.getElementById('video-player');
          if (videoPlayer) videoPlayer.style.display = 'none';
        });

      } catch (error) {
        console.error('Error real en renderDashboard:', error);
        showMessage('error', `Error al cargar datos: ${error.message}`);
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        await renderDashboard(user);
      } else {
        currentUser = null;
        renderLoginPage();
      }
    });

    window.showMessage = showMessage;
  </script>
</body>
</html>
