<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Plataforma OTT - Firebase</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="module">
    let currentUser = null;

    // ‚úÖ content.json
    const CONTENT_URL = 'https://raw.githubusercontent.com/Stefany1-Guerrero/plataforma-ott/main/data/content.json';

    let contentCache = null;
    async function loadContent() {
      if (contentCache) return contentCache;
      const res = await fetch(CONTENT_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error('No se pudo cargar content.json');
      contentCache = await res.json();
      return contentCache;
    }

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      collection,
      addDoc,
      updateDoc
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // ===== YouTube IFrame API + Quiz state =====
    let ytPlayer = null;
    let quizInterval = null;

    // video actual del JSON
    let currentVideoObj = null;
    let currentQuestions = [];
    let askedQuestions = new Set();

    // ========= NUEVO MODELO DE INTENTOS (TABLA) =========
    // Cada vez que abres un video => se crea un "attempt" nuevo (fila) en:
    // users/{uid}/attempts/{attemptId}
    let attemptId = null;
    let attemptPhase = 'idle'; // 'playback' | 'review' | 'ended' | 'idle'

    // Resumen del intento (se guarda por attemptId, no se sobreescribe por videoId)
    let stats = {
      videoId: null,
      attemptId: null,
      startedAt: null,
      endedAt: null,

      // Playback (durante video)
      playbackAnswered: 0,     // preguntas respondidas durante el video (1 intento por pregunta)
      playbackCorrect: 0,
      playbackWrong: 0,
      clicks: 0,

      // Review (al final)
      reviewAnswered: 0,       // preguntas completadas en repaso (cuando aciertas)
      reviewCorrect: 0,
      reviewWrong: 0,
      score: 0
    };

    // Estado por pregunta (durante reproducci√≥n)
    // qState[qid] = { playback: { answered, isCorrect, selectedIndex }, review: { completed, wrongAttempts } }
    let qState = {};

    function isoNow() { return new Date().toISOString(); }

    function calcAccuracyReview() {
      return stats.reviewAnswered ? Math.round((stats.reviewCorrect / stats.reviewAnswered) * 100) : 0;
    }

    function updateScoreboard() {
      const el = document.getElementById('scoreboard');
      if (!el) return;
      // Durante el video mostramos progreso, no puntaje.
      if (attemptPhase === 'playback') {
        el.textContent = `Progreso: ${stats.playbackAnswered}/${currentQuestions.length} | Aciertos: ${stats.playbackCorrect} | Fallos: ${stats.playbackWrong}`;
        return;
      }
      // En repaso/fin mostramos puntaje real
      el.textContent = `Puntaje: ${stats.score} | Repaso completadas: ${stats.reviewAnswered}/${currentQuestions.length}`;
    }

    function updateScoreDetails() {
      const el = document.getElementById('score-details');
      if (!el) return;

      if (attemptPhase === 'playback') {
        el.textContent = `Clics: ${stats.clicks} | (En reproducci√≥n no hay reintentos: si fallas, contin√∫a el video)`;
        return;
      }

      el.textContent = `Repaso ‚Üí Aciertos: ${stats.reviewCorrect} | Errores: ${stats.reviewWrong} | %: ${calcAccuracyReview()}% | Clics: ${stats.clicks}`;
    }

    async function logEvent(type, extra = {}) {
      if (!currentUser) return;
      try {
        await addDoc(collection(db, 'users', currentUser.uid, 'events'), {
          type,
          videoId: stats.videoId,
          attemptId: stats.attemptId,
          phase: attemptPhase,
          ...extra,
          createdAt: isoNow(),
        });
      } catch (e) {
        console.warn('No se pudo guardar evento', e);
      }
    }

    async function createAttempt(videoId) {
      if (!currentUser) return null;
      try {
        const ref = await addDoc(collection(db, 'users', currentUser.uid, 'attempts'), {
          videoId,
          startedAt: isoNow(),
          status: 'in_progress'
        });
        return ref.id;
      } catch (e) {
        console.warn('No se pudo crear attempt', e);
        return null;
      }
    }

    async function saveAttemptSummary(finalStatus = 'finished') {
      if (!currentUser || !stats.attemptId) return;
      try {
        const attemptRef = doc(db, 'users', currentUser.uid, 'attempts', stats.attemptId);
        await updateDoc(attemptRef, {
          videoId: stats.videoId,
          startedAt: stats.startedAt,
          endedAt: stats.endedAt || null,
          status: finalStatus,

          playbackAnswered: stats.playbackAnswered,
          playbackCorrect: stats.playbackCorrect,
          playbackWrong: stats.playbackWrong,
          clicks: stats.clicks,

          reviewAnswered: stats.reviewAnswered,
          reviewCorrect: stats.reviewCorrect,
          reviewWrong: stats.reviewWrong,
          score: stats.score,
          accuracyReview: stats.reviewAnswered ? (stats.reviewCorrect / stats.reviewAnswered) : 0,

          updatedAt: isoNow()
        });
      } catch (e) {
        console.warn('No se pudo guardar resumen del attempt', e);
      }
    }

    async function saveAnswerRow({ questionId, timeInVideo, selectedIndex, isCorrect, phase, wrongAttemptsInReview = 0 }) {
      if (!currentUser || !stats.attemptId) return;
      try {
        // Guardamos ‚Äúfilas‚Äù de respuestas bajo el attempt (m√°s limpio para tu tabla)
        await addDoc(collection(db, 'users', currentUser.uid, 'attempts', stats.attemptId, 'answers'), {
          videoId: stats.videoId,
          attemptId: stats.attemptId,
          questionId,
          timeInVideo,
          selectedIndex,
          isCorrect,
          phase, // 'playback' o 'review'
          wrongAttemptsInReview,
          createdAt: isoNow()
        });
      } catch (e) {
        console.warn('No se pudo guardar respuesta', e);
      }
    }

    // ========= YouTube helpers =========
    function loadYouTubeAPI() {
      return new Promise((resolve) => {
        if (window.YT && window.YT.Player) return resolve();
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        document.head.appendChild(tag);
        window.onYouTubeIframeAPIReady = () => resolve();
      });
    }

    function stopQuizWatcher() {
      if (quizInterval) clearInterval(quizInterval);
      quizInterval = null;
    }

    function startQuizWatcher() {
      stopQuizWatcher();

      quizInterval = setInterval(() => {
        if (!ytPlayer || !currentQuestions.length) return;
        if (attemptPhase !== 'playback') return;

        const t = Math.floor(ytPlayer.getCurrentTime());

        // pregunta exacta en ese segundo (si quieres m√°s tolerancia, se cambia a rango)
        const q = currentQuestions.find(q => q.time === t && !askedQuestions.has(q.id));
        if (q) {
          askedQuestions.add(q.id);
          showQuizPlayback(q);
        }
      }, 500);
    }

    function setOverlayVisible(show) {
      const overlay = document.getElementById('quiz-overlay');
      if (!overlay) return;
      overlay.style.display = show ? 'flex' : 'none';
    }

    function disableOptionButtons() {
      const optsEl = document.getElementById('quiz-options');
      if (!optsEl) return;
      optsEl.querySelectorAll('button').forEach(b => {
        b.disabled = true;
        b.classList.add('opacity-60', 'cursor-not-allowed');
      });
    }

    // ========= NUEVO: DURANTE VIDEO (1 intento y SIGUE) =========
    function showQuizPlayback(q) {
      try { ytPlayer.pauseVideo(); } catch {}

      const qEl = document.getElementById('quiz-question');
      const optsEl = document.getElementById('quiz-options');
      const fbEl = document.getElementById('quiz-feedback');
      const btnContinue = document.getElementById('quiz-continue');

      qEl.textContent = q.question;
      fbEl.textContent = 'Selecciona una opci√≥n (si fallas, se registrar√° y el video continuar√°).';
      fbEl.className = "text-sm mt-3 text-gray-300";
      btnContinue.style.display = 'none';
      optsEl.innerHTML = '';

      // asegurar estado
      if (!qState[q.id]) {
        qState[q.id] = {
          playback: { answered: false, isCorrect: false, selectedIndex: null },
          review: { completed: false, wrongAttempts: 0 }
        };
      }

      q.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = "w-full text-left bg-gray-700/60 hover:bg-gray-600/60 text-white rounded-lg px-4 py-3 transition-all";
        btn.textContent = opt;

        btn.addEventListener('click', async () => {
          // 1) cuenta clic
          stats.clicks += 1;
          updateScoreDetails();
          await logEvent('select_option', { questionId: q.id, optionIndex: idx, timeInVideo: q.time });

          // 2) evita reintentos en playback
          disableOptionButtons();

          const isCorrect = idx === q.correctIndex;

          // marcar respuesta de playback solo una vez
          if (!qState[q.id].playback.answered) {
            qState[q.id].playback.answered = true;
            qState[q.id].playback.selectedIndex = idx;
            qState[q.id].playback.isCorrect = isCorrect;

            stats.playbackAnswered += 1;
            if (isCorrect) stats.playbackCorrect += 1;
            else stats.playbackWrong += 1;

            updateScoreboard();
            updateScoreDetails();

            await saveAnswerRow({
              questionId: q.id,
              timeInVideo: q.time,
              selectedIndex: idx,
              isCorrect,
              phase: 'playback'
            });

            await saveAttemptSummary('in_progress');
          }

          // feedback corto y continuar SOLO
          if (isCorrect) {
            fbEl.textContent = `‚úÖ Correcto. Continuando...`;
            fbEl.className = "text-sm mt-3 text-green-300";
          } else {
            fbEl.textContent = `‚ùå Incorrecto. Se registr√≥ el fallo. Continuando...`;
            fbEl.className = "text-sm mt-3 text-red-300";
          }

          setTimeout(async () => {
            setOverlayVisible(false);
            await logEvent('resume_after_answer', { questionId: q.id, timeInVideo: q.time, isCorrect });
            try { ytPlayer.playVideo(); } catch {}
          }, 900);
        });

        optsEl.appendChild(btn);
      });

      setOverlayVisible(true);
    }

    // ========= NUEVO: REPASO AL FINAL (aqu√≠ s√≠ reintentas hasta acertar) =========
    let reviewQueue = [];
    let reviewIndex = 0;

    function buildReviewQueue(mode = 'wrong_only') {
      // wrong_only: solo las que fall√≥ en playback
      // all: todas
      const all = currentQuestions.slice();
      if (mode === 'all') return all;

      return all.filter(q => {
        const st = qState[q.id]?.playback;
        // si no respondi√≥ durante el video, tambi√©n entra al repaso
        if (!st || !st.answered) return true;
        return st.answered && !st.isCorrect;
      });
    }

    function startReview(mode = 'wrong_only') {
      attemptPhase = 'review';
      reviewQueue = buildReviewQueue(mode);
      reviewIndex = 0;

      updateScoreboard();
      updateScoreDetails();

      if (!reviewQueue.length) {
        showEndModal(true); // mostrar resultados igual
        return;
      }
      showReviewQuestion(reviewQueue[reviewIndex]);
    }

    function showReviewQuestion(q) {
      // (video ya termin√≥ o est√° pausado)
      try { ytPlayer.pauseVideo(); } catch {}

      const qEl = document.getElementById('quiz-question');
      const optsEl = document.getElementById('quiz-options');
      const fbEl = document.getElementById('quiz-feedback');
      const btnContinue = document.getElementById('quiz-continue');

      if (!qState[q.id]) {
        qState[q.id] = {
          playback: { answered: false, isCorrect: false, selectedIndex: null },
          review: { completed: false, wrongAttempts: 0 }
        };
      }

      qEl.textContent = `REPASO (${reviewIndex + 1}/${reviewQueue.length}) ‚Üí ${q.question}`;
      fbEl.textContent = 'Responde hasta acertar. El puntaje se calcula aqu√≠.';
      fbEl.className = "text-sm mt-3 text-gray-300";
      btnContinue.style.display = 'none';
      btnContinue.textContent = 'Siguiente';
      optsEl.innerHTML = '';

      q.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = "w-full text-left bg-gray-700/60 hover:bg-gray-600/60 text-white rounded-lg px-4 py-3 transition-all";
        btn.textContent = opt;

        btn.addEventListener('click', async () => {
          stats.clicks += 1;
          updateScoreDetails();
          await logEvent('review_select_option', { questionId: q.id, optionIndex: idx, timeInVideo: q.time });

          const isCorrect = idx === q.correctIndex;

          if (isCorrect) {
            fbEl.textContent = `‚úÖ Correcto. ${q.explanation || ''}`;
            fbEl.className = "text-sm mt-3 text-green-300";

            // contar solo primera vez que completa en repaso
            if (!qState[q.id].review.completed) {
              qState[q.id].review.completed = true;

              stats.reviewCorrect += 1;
              stats.reviewAnswered += 1;
              stats.score += 1; // 1 punto por pregunta completada en repaso

              // guardar fila de respuesta en repaso
              await saveAnswerRow({
                questionId: q.id,
                timeInVideo: q.time,
                selectedIndex: idx,
                isCorrect: true,
                phase: 'review',
                wrongAttemptsInReview: qState[q.id].review.wrongAttempts
              });

              await saveAttemptSummary('in_progress');
            }

            // habilitar "Siguiente"
            btnContinue.style.display = 'inline-flex';
            btnContinue.onclick = async () => {
              reviewIndex += 1;
              if (reviewIndex >= reviewQueue.length) {
                setOverlayVisible(false);
                await logEvent('review_finished');
                showEndModal(true);
                return;
              }
              showReviewQuestion(reviewQueue[reviewIndex]);
            };
          } else {
            fbEl.textContent = `‚ùå Incorrecto. Intenta otra vez.`;
            fbEl.className = "text-sm mt-3 text-red-300";

            stats.reviewWrong += 1;
            qState[q.id].review.wrongAttempts += 1;

            updateScoreDetails();
            await logEvent('review_wrong_attempt', { questionId: q.id, timeInVideo: q.time });

            await saveAttemptSummary('in_progress');
          }

          updateScoreboard();
          updateScoreDetails();
        });

        optsEl.appendChild(btn);
      });

      setOverlayVisible(true);
    }

    // ========= MODAL FINAL =========
    function showEndModal(show) {
      const modal = document.getElementById('end-modal');
      if (!modal) return;
      modal.style.display = show ? 'flex' : 'none';

      const summary = document.getElementById('end-summary');
      if (summary) {
        const total = currentQuestions.length;
        const wrongInPlayback = Object.values(qState).filter(s => s.playback?.answered && !s.playback.isCorrect).length;
        const unansweredInPlayback = currentQuestions.filter(q => !qState[q.id]?.playback?.answered).length;

        summary.innerHTML = `
          <div class="text-sm text-gray-200 space-y-2">
            <div><b>Video:</b> ${stats.videoId}</div>
            <div><b>Attempt ID:</b> ${stats.attemptId || '-'}</div>
            <hr class="border-white/10 my-2"/>
            <div class="text-gray-300"><b>Durante video:</b> respondidas ${stats.playbackAnswered}/${total}, aciertos ${stats.playbackCorrect}, fallos ${stats.playbackWrong}</div>
            <div class="text-gray-300"><b>Para repaso:</b> incorrectas ${wrongInPlayback}, no respondidas ${unansweredInPlayback}</div>
            <hr class="border-white/10 my-2"/>
            <div class="text-gray-100"><b>Puntaje repaso:</b> ${stats.score}</div>
            <div class="text-gray-300"><b>Repaso:</b> completadas ${stats.reviewAnswered}/${total}, % ${calcAccuracyReview()}%</div>
          </div>
        `;
      }
    }

    // Configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCu-GYKblx8v94XMLeIEbpwpxJjxmihyaE",
      authDomain: "plataforma-ott.firebaseapp.com",
      projectId: "plataforma-ott",
      storageBucket: "plataforma-ott.firebasestorage.app",
      messagingSenderId: "623885901425",
      appId: "1:623885901425:web:d3fa5079d942eb064a05d0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    function showMessage(type, text) {
      const messageDiv = document.getElementById('message');
      if (!messageDiv) return;

      messageDiv.className = `flex items-center gap-2 p-4 rounded-lg mb-6 ${type === 'error' ? 'bg-red-500/20 border border-red-500/50' : 'bg-green-500/20 border border-green-500/50'}`;
      messageDiv.innerHTML = `
        <span class="text-2xl">${type === 'error' ? '‚ö†Ô∏è' : '‚úÖ'}</span>
        <span class="${type === 'error' ? 'text-red-300' : 'text-green-300'}">${text}</span>
      `;
      messageDiv.style.display = 'flex';

      if (type === 'success') {
        setTimeout(() => { messageDiv.style.display = 'none'; }, 3000);
      }
    }

    async function handleRegister() {
      const name = document.getElementById('reg-name').value.trim();
      const email = document.getElementById('reg-email').value.trim();
      const password = document.getElementById('reg-password').value;
      const confirmPassword = document.getElementById('reg-confirm').value;

      if (!name || !email || !password || !confirmPassword) {
        showMessage('error', 'Todos los campos son obligatorios');
        return;
      }
      if (password !== confirmPassword) {
        showMessage('error', 'Las contrase√±as no coinciden');
        return;
      }
      if (password.length < 6) {
        showMessage('error', 'La contrase√±a debe tener al menos 6 caracteres');
        return;
      }

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        await setDoc(doc(db, 'users', user.uid), {
          name,
          email,
          createdAt: isoNow(),
          subscription: 'basic'
        });

        showMessage('success', '¬°Registro exitoso! Redirigiendo...');
        setTimeout(() => {
          document.getElementById('reg-name').value = '';
          document.getElementById('reg-email').value = '';
          document.getElementById('reg-password').value = '';
          document.getElementById('reg-confirm').value = '';
          switchToLogin();
        }, 2000);

      } catch (error) {
        console.error('Error:', error);
        let errorMessage = 'Error al registrar usuario';
        if (error.code === 'auth/email-already-in-use') errorMessage = 'Este email ya est√° registrado';
        else if (error.code === 'auth/invalid-email') errorMessage = 'Email inv√°lido';
        else if (error.code === 'auth/weak-password') errorMessage = 'La contrase√±a es muy d√©bil';
        showMessage('error', errorMessage);
      }
    }

    async function handleLogin() {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;

      if (!email || !password) {
        showMessage('error', 'Email y contrase√±a son obligatorios');
        return;
      }

      try {
        await signInWithEmailAndPassword(auth, email, password);
        showMessage('success', 'Iniciando sesi√≥n...');
      } catch (error) {
        console.error('Error:', error);
        let errorMessage = 'Error al iniciar sesi√≥n';
        if (error.code === 'auth/user-not-found') errorMessage = 'Usuario no encontrado';
        else if (error.code === 'auth/wrong-password') errorMessage = 'Contrase√±a incorrecta';
        else if (error.code === 'auth/invalid-credential') errorMessage = 'Email o contrase√±a incorrectos';
        else if (error.code === 'auth/too-many-requests') errorMessage = 'Demasiados intentos. Intenta m√°s tarde';
        showMessage('error', errorMessage);
      }
    }

    async function handleLogout() {
      try {
        await signOut(auth);
        showMessage('success', 'Sesi√≥n cerrada exitosamente');
      } catch (error) {
        console.error('Error:', error);
        showMessage('error', 'Error al cerrar sesi√≥n');
      }
    }

    function renderLoginPage() {
      document.getElementById('root').innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 flex items-center justify-center p-4">
          <div class="bg-gray-800/50 backdrop-blur-lg rounded-2xl shadow-2xl p-8 w-full max-w-md border border-purple-500/20">
            <div class="text-center mb-8">
              <div class="text-6xl mb-4">üé¨</div>
              <h1 class="text-4xl font-bold text-white mb-2">Plataforma OTT</h1>
              <p class="text-gray-400">Con Firebase Database üî•</p>
            </div>

            <div id="message" style="display: none;"></div>

            <div class="flex gap-2 mb-6 bg-gray-700/30 p-1 rounded-lg">
              <button id="btn-login-tab" class="flex-1 py-2 px-4 rounded-md transition-all bg-gradient-to-r from-purple-500 to-pink-500 text-white">
                Iniciar Sesi√≥n
              </button>
              <button id="btn-register-tab" class="flex-1 py-2 px-4 rounded-md transition-all text-gray-400 hover:text-white">
                Registrarse
              </button>
            </div>

            <div id="login-form">
              <div class="space-y-4">
                <div>
                  <label class="block text-gray-300 mb-2 text-sm">üìß Email</label>
                  <input type="email" id="login-email" placeholder="tu@email.com"
                    class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                </div>
                <div>
                  <label class="block text-gray-300 mb-2 text-sm">üîí Contrase√±a</label>
                  <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                </div>
                <button id="btn-login" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600 transition-all transform hover:scale-105">
                  Iniciar Sesi√≥n
                </button>
              </div>
            </div>

            <div id="register-form" style="display: none;">
              <div class="space-y-4">
                <div>
                  <label class="block text-gray-300 mb-2 text-sm">üë§ Nombre Completo</label>
                  <input type="text" id="reg-name" placeholder="Juan P√©rez"
                    class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                </div>
                <div>
                  <label class="block text-gray-300 mb-2 text-sm">üìß Email</label>
                  <input type="email" id="reg-email" placeholder="tu@email.com"
                    class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                </div>
                <div>
                  <label class="block text-gray-300 mb-2 text-sm">üîí Contrase√±a (m√≠n. 6 caracteres)</label>
                  <input type="password" id="reg-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                </div>
                <div>
                  <label class="block text-gray-300 mb-2 text-sm">üîí Confirmar Contrase√±a</label>
                  <input type="password" id="reg-confirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    class="w-full bg-gray-700/50 border border-gray-600 rounded-lg py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition-all">
                </div>
                <button id="btn-register" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600 transition-all transform hover:scale-105">
                  Crear Cuenta
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('btn-login-tab').addEventListener('click', switchToLogin);
      document.getElementById('btn-register-tab').addEventListener('click', switchToRegister);
      document.getElementById('btn-login').addEventListener('click', handleLogin);
      document.getElementById('btn-register').addEventListener('click', handleRegister);
    }

    function switchToLogin() {
      document.getElementById('login-form').style.display = 'block';
      document.getElementById('register-form').style.display = 'none';
      document.getElementById('btn-login-tab').className = 'flex-1 py-2 px-4 rounded-md transition-all bg-gradient-to-r from-purple-500 to-pink-500 text-white';
      document.getElementById('btn-register-tab').className = 'flex-1 py-2 px-4 rounded-md transition-all text-gray-400 hover:text-white';
      const messageDiv = document.getElementById('message');
      if (messageDiv) messageDiv.style.display = 'none';
    }

    function switchToRegister() {
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('register-form').style.display = 'block';
      document.getElementById('btn-login-tab').className = 'flex-1 py-2 px-4 rounded-md transition-all text-gray-400 hover:text-white';
      document.getElementById('btn-register-tab').className = 'flex-1 py-2 px-4 rounded-md transition-all bg-gradient-to-r from-purple-500 to-pink-500 text-white';
      const messageDiv = document.getElementById('message');
      if (messageDiv) messageDiv.style.display = 'none';
    }

    async function renderDashboard(user) {
      try {
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        const userData = userDoc.data();

        document.getElementById('root').innerHTML = `
          <div class="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 flex items-center justify-center p-4">
            <div class="bg-gray-800/50 backdrop-blur-lg rounded-2xl shadow-2xl p-8 w-full max-w-4xl border border-purple-500/20">
              <div class="flex items-center justify-between mb-8 flex-wrap gap-4">
                <h1 class="text-3xl font-bold text-white">üé¨ Mi Plataforma OTT</h1>
                <button id="btn-logout" class="px-6 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all">
                  Cerrar Sesi√≥n
                </button>
              </div>

              <div id="message" style="display: none;"></div>

              <div class="bg-gray-700/30 rounded-xl p-6 mb-6">
                <h2 class="text-2xl font-semibold text-white mb-4">¬°Bienvenido, ${userData?.name || 'Usuario'}! üëã</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-300">
                  <p>üìß Email: ${userData?.email || user.email}</p>
                  <p>üíé Plan: ${(userData?.subscription || 'basic').toUpperCase()}</p>
                  <p>‚úÖ Estado: Activo</p>
                  <p>üìÖ Miembro desde: ${userData?.createdAt ? new Date(userData.createdAt).toLocaleDateString() : '-'}</p>
                  <p>üî• Base de datos: Firebase Firestore</p>
                  <p>üîí Seguridad: Activada</p>
                </div>
              </div>

              <div class="bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-xl p-6 border border-purple-500/30">
                <h3 class="text-xl font-semibold text-white mb-3">Contenido Disponible</h3>
                <p class="text-gray-300 mb-4">Explora todo el contenido de streaming disponible.</p>

                <div id="video-grid" class="grid grid-cols-2 md:grid-cols-3 gap-3">
                  ${[1,2,3,4,5,6].map(num => `
                    <button class="video-btn bg-gray-700/50 rounded-lg p-4 text-center hover:bg-gray-600/50 transition-all cursor-pointer" data-video="${num}">
                      <p class="text-white font-medium text-sm md:text-base">üé¨ Video ${num}</p>
                    </button>
                  `).join('')}
                </div>

                <div id="video-player" style="display: none;" class="mt-6">
                  <div class="flex items-center justify-between mb-3 gap-3 flex-wrap">
                    <div>
                      <h4 class="text-lg font-semibold text-white" id="video-title"></h4>
                      <div class="text-sm text-gray-200 mt-1" id="scoreboard">Progreso: 0/0 | Aciertos: 0 | Fallos: 0</div>
                      <div class="text-xs text-gray-300 mt-1" id="score-details">Clics: 0</div>
                    </div>

                    <button id="close-video" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all">
                      Cerrar
                    </button>
                  </div>

                  <div class="relative" style="padding-bottom: 56.25%; height: 0;">
                    <div class="relative" style="padding-bottom: 56.25%; height: 0;">
                      <div id="youtube-player" style="position:absolute; top:0; left:0; width:100%; height:100%;"></div>

                      <div id="quiz-overlay"
                        style="display:none; position:absolute; top:0; left:0; width:100%; height:100%;"
                        class="bg-black/70 flex items-center justify-center p-4">
                        <div class="w-full max-w-xl bg-gray-800 rounded-xl border border-purple-500/30 p-5">
                          <h4 id="quiz-question" class="text-white text-lg font-semibold mb-4"></h4>
                          <div id="quiz-options" class="grid grid-cols-1 gap-2"></div>
                          <p id="quiz-feedback" class="text-sm mt-3 text-gray-300"></p>

                          <div class="flex justify-end gap-2 mt-4">
                            <button id="quiz-continue"
                              class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg"
                              style="display:none;">
                              Continuar
                            </button>
                          </div>
                        </div>
                      </div>

                      <!-- Modal final -->
                      <div id="end-modal" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%;"
                        class="bg-black/70 flex items-center justify-center p-4">
                        <div class="w-full max-w-2xl bg-gray-900 rounded-2xl border border-purple-500/30 p-6">
                          <h3 class="text-white text-xl font-bold mb-3">‚úÖ Video finalizado ‚Äî Resultados del intento</h3>
                          <div id="end-summary" class="mb-4"></div>

                          <div class="flex flex-wrap gap-2 justify-end">
                            <button id="btn-review-wrong" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg">
                              Repasar incorrectas/no respondidas
                            </button>
                            <button id="btn-review-all" class="px-4 py-2 bg-purple-600/70 hover:bg-purple-700 text-white rounded-lg">
                              Repasar todas
                            </button>
                            <button id="btn-retry-video" class="px-4 py-2 bg-pink-600 hover:bg-pink-700 text-white rounded-lg">
                              Repetir video (nuevo intento)
                            </button>
                            <button id="btn-end-close" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg">
                              Cerrar
                            </button>
                          </div>

                          <p class="text-xs text-gray-400 mt-4">
                            Cada vez que repites el video se crea un nuevo intento (fila) en Firestore: <b>users/{uid}/attempts</b>.
                          </p>
                        </div>
                      </div>

                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        `;

        document.getElementById('btn-logout').addEventListener('click', handleLogout);

        const data = await loadContent();

        const videoLinks = {};
        const videoTitles = {};
        data.videos.forEach(v => {
          videoLinks[String(v.id)] = v.youtubeId;
          videoTitles[String(v.id)] = v.title || `Video ${v.id}`;
        });

        async function openVideo(videoNum) {
          const videoId = videoLinks[String(videoNum)];
          const videoPlayer = document.getElementById('video-player');
          const videoTitle = document.getElementById('video-title');

          // Cargar preguntas del video
          currentVideoObj = data.videos.find(v => String(v.id) === String(videoNum)) || null;
          currentQuestions = (currentVideoObj?.questions || []).slice().sort((a,b) => a.time - b.time);
          askedQuestions = new Set();

          // reset intento (nuevo)
          attemptPhase = 'playback';
          qState = {};

          const newAttemptId = await createAttempt(Number(videoNum));
          attemptId = newAttemptId;

          stats = {
            videoId: Number(videoNum),
            attemptId,
            startedAt: isoNow(),
            endedAt: null,

            playbackAnswered: 0,
            playbackCorrect: 0,
            playbackWrong: 0,
            clicks: 0,

            reviewAnswered: 0,
            reviewCorrect: 0,
            reviewWrong: 0,
            score: 0
          };

          updateScoreboard();
          updateScoreDetails();

          await logEvent('open_video', { videoId: stats.videoId });

          await loadYouTubeAPI();

          const playerDivId = 'youtube-player';

          if (ytPlayer) {
            ytPlayer.loadVideoById(videoId);
          } else {
            ytPlayer = new YT.Player(playerDivId, {
              videoId,
              playerVars: { autoplay: 1, rel: 0 },
              events: {
                onReady: async () => {
                  await logEvent('player_ready', { videoId: stats.videoId });
                  startQuizWatcher();
                },
                onStateChange: async (e) => {
                  if (e.data === YT.PlayerState.PLAYING) {
                    await logEvent('play', { videoId: stats.videoId });
                    startQuizWatcher();
                  }
                  if (e.data === YT.PlayerState.PAUSED) {
                    await logEvent('pause', { videoId: stats.videoId });
                  }
                  if (e.data === YT.PlayerState.ENDED) {
                    // VIDEO TERMIN√ì
                    attemptPhase = 'ended';
                    stopQuizWatcher();

                    stats.endedAt = isoNow();
                    await logEvent('ended', { videoId: stats.videoId });

                    await saveAttemptSummary('finished');
                    updateScoreboard();
                    updateScoreDetails();

                    showEndModal(true);
                  }
                }
              }
            });
          }

          // mostrar UI player
          videoTitle.textContent = videoTitles[String(videoNum)] || `Video ${videoNum}`;
          videoPlayer.style.display = 'block';
          videoPlayer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

          // iniciar watcher
          startQuizWatcher();
        }

        // Botones de video
        document.querySelectorAll('.video-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const videoNum = btn.dataset.video;
            await openVideo(videoNum);
          });
        });

        // Bot√≥n cerrar reproductor
        document.getElementById('close-video').addEventListener('click', async () => {
          const videoPlayer = document.getElementById('video-player');
          stopQuizWatcher();
          setOverlayVisible(false);
          showEndModal(false);

          if (ytPlayer) {
            try { ytPlayer.stopVideo(); } catch {}
          }

          // si estaba en progreso, lo marcamos cerrado
          if (stats?.attemptId) {
            stats.endedAt = stats.endedAt || isoNow();
            await logEvent('close_video', { videoId: stats.videoId });
            await saveAttemptSummary('closed');
          }

          videoPlayer.style.display = 'none';
          attemptPhase = 'idle';
        });

        // Acciones del modal final
        document.addEventListener('click', async (e) => {
          if (e.target?.id === 'btn-end-close') {
            showEndModal(false);
            return;
          }

          if (e.target?.id === 'btn-review-wrong') {
            showEndModal(false);
            await logEvent('start_review', { mode: 'wrong_only' });
            startReview('wrong_only');
            return;
          }

          if (e.target?.id === 'btn-review-all') {
            showEndModal(false);
            await logEvent('start_review', { mode: 'all' });
            startReview('all');
            return;
          }

          if (e.target?.id === 'btn-retry-video') {
            showEndModal(false);
            // repetir video => NUEVO INTENTO
            const vid = stats.videoId;
            await logEvent('retry_video_new_attempt', { videoId: vid });

            // reinicia player desde 0 y crea attempt nuevo
            await openVideo(vid);
            return;
          }
        });

      } catch (error) {
        console.error('Error al cargar datos:', error);
        showMessage('error', 'Error al cargar informaci√≥n del usuario');
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        await renderDashboard(user);
      } else {
        currentUser = null;
        renderLoginPage();
      }
    });

    window.showMessage = showMessage;
  </script>
</body>
</html>
